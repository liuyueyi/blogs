<!DOCTYPE html><html lang="zh-CN"><head><meta name="google-site-verification" content="PR6S72-htn-N1oDn9ENMcwi5niLKk0uebDzmRS-oivs"><meta property="wb:webmaster" content="320520520031fedd"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="好好学习，努力搬砖，天天吃草"><title>2. SPI框架实现之旅二：整体设计 | 一灰灰Blog</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/hexblog/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/hexblog/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/hexblog/favicon.ico"><link rel="bookmark" href="/hexblog/favicon.ico"><link rel="apple-touch-icon" href="/hexblog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/hexblog/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">2. SPI框架实现之旅二：整体设计</h1><a id="logo" href="/hexblog/.">一灰灰Blog</a><p style="font-size:18px" class="description">一灰灰的个人博客网站</p></div><div id="nav-menu"><a href="/hexblog/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/hexblog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/hexblog/about/"><i class="fa fa-user"> 关于</i></a><a href="https://zbang.online/webs"><i class="fa fa-rss"> 网站</i></a><hr><br><div id="nav-sub-menu"><a href="/hexblog/categories/技术"><i class="fa fa-right"> 技术</i></a><a href="/hexblog/categories/工作"><i class="fa fa-right"> 工作</i></a><a href="/hexblog/categories/生活"><i class="fa fa-right"> 生活</i></a><a href="/hexblog/categories/杂记"><i class="fa fa-right"> 杂记</i></a></div></div>
<div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="blog"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/hexblog/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">2. SPI框架实现之旅二：整体设计 <span style="font-size:14px;color:#40759b;font-style:italic;border-bottom: 1px solid #e5e5e5;">&gt;&gt;&gt; by 一灰灰Blog</span></h1><div class="post-meta"><a href="/hexblog/2017/05/28/SPI框架实现之旅二：整体设计/#saveImg" class="saveImg-icon"></a><a href="/hexblog/2017/05/28/SPI框架实现之旅二：整体设计/#comments" class="comment-count"></a><p><span class="date">May 28, 2017</span><span><a href="/hexblog/categories/技术/" class="category">技术</a><a href="/hexblog/categories/技术/Quick系列项目/" class="category">Quick系列项目</a><a href="/hexblog/categories/技术/Quick系列项目/QuickSpi/" class="category">QuickSpi</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h1 id="整体设计"><a href="#整体设计" class="headerlink" title="整体设计"></a>整体设计</h1><blockquote>
<p>上一篇简单的说了一下spi相关的东西， 接下来我们准备开动，本篇博文主要集中在一些术语，使用规范的约定和使用方式</p>
</blockquote>
<a id="more"></a>
<h2 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h2><p>下图围绕 <code>SpiLoader</code> 为中心，描述了三个主要的流程： </p>
<ol>
<li>load所有的spi实现</li>
<li>初始化选择器 selector</li>
<li>获取spi实现类 （or一个实现类代理）</li>
</ol>
<p><img src="https://static.oschina.net/uploads/img/201705/26185143_ULnL.png" alt="https://static.oschina.net/uploads/img/201705/26185143_ULnL.png"></p>
<hr>
<h2 id="基础类说明"><a href="#基础类说明" class="headerlink" title="基础类说明"></a>基础类说明</h2><blockquote>
<p>主要介绍一下框架中涉及到的接口和注解，并指出需要注意的点</p>
</blockquote>
<h3 id="1-Selector-选择器"><a href="#1-Selector-选择器" class="headerlink" title="1. Selector 选择器"></a>1. <code>Selector</code> 选择器</h3><blockquote>
<p>为了最大程度的支持业务方对spi实现类的选择，我们定义了一个选择器的概念，用于获取spi实现类</p>
</blockquote>
<h4 id="接口定义如下"><a href="#接口定义如下" class="headerlink" title="接口定义如下:"></a>接口定义如下:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISelector</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    &lt;K&gt; <span class="function">K <span class="title">selector</span><span class="params">(Map&lt;String, SpiImplWrapper&lt;K&gt;&gt; map, T conf)</span> <span class="keyword">throws</span> NoSpiMatchException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="结合上面的接口定义，我们可以考虑下，选择器应该如何工作？"><a href="#结合上面的接口定义，我们可以考虑下，选择器应该如何工作？" class="headerlink" title="结合上面的接口定义，我们可以考虑下，选择器应该如何工作？"></a>结合上面的接口定义，我们可以考虑下，选择器应该如何工作？</h4><ul>
<li>根据传入的条件，从所有的实现类中，找到一个最匹配的实现类返回</li>
<li>如果查不到，则抛一个异常<code>NoSpiMatchException</code>出去</li>
</ul>
<p>所以传入的参数会是两个， 一个是所有的实现类列表<code>map</code>（至于上面为什么用map，后续分析），一个是用于判断的输入条件<code>conf</code></p>
<h4 id="框架中会提供两种基本的选择器实现，"><a href="#框架中会提供两种基本的选择器实现，" class="headerlink" title="框架中会提供两种基本的选择器实现，"></a>框架中会提供两种基本的选择器实现，</h4><ul>
<li><code>DefaultSelector</code> ， 对每个实现类赋予唯一的name，默认选择器则表示根据name来查找实现类</li>
<li><code>ParamsSelector</code>， 在实现类上加上 <code>@SpiConf</code> 注解，定义其中的 <code>params</code>，当传入的参数(<code>conf</code>)， 能完全匹配定义的params，表示这个实现类就是你所需要的</li>
</ul>
<h4 id="自定义实现"><a href="#自定义实现" class="headerlink" title="自定义实现"></a>自定义实现</h4><p>自定义实现比较简单，实现上面的接口即可</p>
<h3 id="2-Spi-注解"><a href="#2-Spi-注解" class="headerlink" title="2. Spi 注解"></a>2. <code>Spi</code> 注解</h3><blockquote>
<p>要求所有的spi接口，都必须有这个注解；</p>
</blockquote>
<h4 id="定义如下"><a href="#定义如下" class="headerlink" title="定义如下"></a>定义如下</h4><p>主要是有一个参数，用于指定是选择器类型，定义spi接口的默认选择器， </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Spi &#123;</span><br><span class="line">    Class&lt;? extends ISelector&gt; selector() <span class="keyword">default</span> DefaultSelector.class;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>在上一篇《SPI框架实现之旅一》中，使用jdk的spi方式中，并没有使用注解依然可以正常工作，我们这里定义这个注解且要求必需有，出于下面几个考虑</p>
<ul>
<li>醒目，告诉开发者，这个接口是声明的spi接口， 使用的时候注意下</li>
<li>加入选择器参数，方便用户扩展自己的选择方式</li>
</ul>
<h3 id="3-SpiAdaptive-注解"><a href="#3-SpiAdaptive-注解" class="headerlink" title="3. SpiAdaptive 注解"></a>3. <code>SpiAdaptive</code> 注解</h3><blockquote>
<p>对需要自适应的场景，为了满足一个spi接口，应用多重不同的选择器场景，可以加上这个注解；<br>如果不加这个注解，则表示采用默认的选择器来自适应</p>
</blockquote>
<h4 id="接口说明"><a href="#接口说明" class="headerlink" title="接口说明"></a>接口说明</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SPI 自适应注解, 表示该方法会用到spi实现</span></span><br><span class="line"><span class="comment"> * &lt;p/&gt;</span></span><br><span class="line"><span class="comment"> * Created by yihui on 2017/5/24.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpiAdaptive &#123;</span><br><span class="line">    Class&lt;? extends ISelector&gt; selector() <span class="keyword">default</span> DefaultSelector.class;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h4><p>这个注解内容和 @Spi 基本上一模一样，唯一的区别是一个放在类上，一个放在方法上，那么为什么这么考虑？</p>
<ul>
<li><code>@Spi</code> 注解放在类上，更多的表名这个接口是我们定义的一个SPI接口，但是使用方式可以有两种（静态 + 动态确认）</li>
<li><code>@SpiAdaptive</code> 只能在自适应的场景下使用，用于额外指定spi接口中某个方法的选择器 （如果一个spi接口全部只需要一个选择器即可，那么可以不使用这个注解）</li>
</ul>
<p>如下面的这个例子，print方法和 echo方法其实是等价的，都是采用 <code>DefaultSelector</code> 来确认具体的实现类；而 <code>write</code> 和 <code>pp</code> 方法则是采用  <code>ParamsSelector</code> 选择器;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by yihui on 2017/5/25.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Spi</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(String name, String contet)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SpiAdaptive</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">echo</span><span class="params">(String name, String content)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SpiAdaptive</span>(selector = ParamsSelector.class)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(Context context, String content)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SpiAdaptive</span>(selector = ParamsSelector.class)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pp</span><span class="params">(Context context, String content)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-SpiConf-注解"><a href="#4-SpiConf-注解" class="headerlink" title="4. SpiConf 注解"></a>4. <code>SpiConf</code> 注解</h3><blockquote>
<p>这个主键主要是用在实现类上（或实现类的方法上），里面存储一些选择条件，通常是和<code>Selector</code>搭配使用</p>
</blockquote>
<h4 id="定义如下-1"><a href="#定义如下-1" class="headerlink" title="定义如下"></a>定义如下</h4><p>定义了三个字段:</p>
<ul>
<li>name 唯一标识，用于 <code>DefaultSelector</code>； </li>
<li>params 参数条件， 用于 <code>ParamsSelector</code>； </li>
<li>order : 优先级， 主要是为了解决多个实现类都满足选择条件时， 应该选择哪一个 （谈到这里就有个想法， 通过一个参数，来选择是否让满足条件的全部返回）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpiConf &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 唯一标识</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参数过滤, 单独一个元素,表示参数必须包含; 用英文分号,左边为参数名,右边为参数值,表示参数的值必须是右边的</span></span><br><span class="line"><span class="comment">     * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">     * 形如  &#123;"a", "a:12", "b:TAG"&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] params() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序, 越小优先级越高</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">order</span><span class="params">()</span> <span class="keyword">default</span> -1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h4><p><code>SpiConf</code> 注解可以修饰类，也可以修饰方法，因此当一个实现类中，类和方法都有这个注解时， 怎么处理 ？</p>
<p>以下面的这个测试类进行说明</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by yihui on 2017/5/25.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpiConf</span>(params = <span class="string">"code"</span>, order = <span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsoleCode</span> <span class="keyword">implements</span> <span class="title">ICode</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String name, String contet)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"console print:---&gt;"</span> + contet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 显示指定了name, 因此可以直接通过 consoleEcho 来确定调用本实现方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SpiConf</span>(name = <span class="string">"consoleEcho"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">echo</span><span class="params">(String name, String content)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"console echo:----&gt;"</span> + content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实际的优先级取 方法 和类上的最高优先级, 实际为1； </span></span><br><span class="line"><span class="comment">     * `ParamsSelector`选择器时， 执行该方法的条件等同于  `&#123;"code", "type:console"&#125;`</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SpiConf</span>(params = &#123;<span class="string">"type:console"</span>&#125;, order = <span class="number">3</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Context context, String content)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"console write:----&gt;"</span> + content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在设计中，遵循下面几个原则：</p>
<ul>
<li>类上的<code>SpiConf</code>注解， 默认适用与类中的所有方法</li>
<li>方法上有<code>SpiConf</code>注解，采取下面的规则<ul>
<li>方法注解声明name时，两个会同时生效，即想调用上面的echo方法， 通过传入 <code>ConsoleCode</code>（类注解不显示赋值时，采用类名代替） 和 <code>consoleEcho</code> 等价</li>
<li>方法注解未声明name时，只能通过类注解上定义的name（or默认的类名）来选择</li>
<li>order，取最高优先级，如上面的 <code>write</code> 方法的优先级是 1;   当未显示定义order时，以定义的为准</li>
<li>params: 取并集，即要求类上 + 方法上的条件都满足</li>
</ul>
</li>
</ul>
<h2 id="SPI加载器"><a href="#SPI加载器" class="headerlink" title="SPI加载器"></a>SPI加载器</h2><blockquote>
<p>spi加载器的主要业务逻辑集中在  <code>SpiLoader</code> 类中，包含通过spi接口，获取所有的实现类； 获取spi接口对应的选择器 （包括类对应的选择器， 方法对应的选择器）； 返回Spi接口实现类（静态确认的实现类，自适应的代理类）</p>
</blockquote>
<p>从上面的简述，基本上可以看出这个类划分为三个功能点， 下面将逐一说明，本篇博文主要集中在逻辑的设计层，至于优化（如懒加载，缓存优化等） 放置下一篇博文单独叙述</p>
<h3 id="1-加载spi实现类"><a href="#1-加载spi实现类" class="headerlink" title="1. 加载spi实现类"></a>1. 加载spi实现类</h3><blockquote>
<p>这一块比较简单，我们直接利用了jdk的 <code>ServiceLoader</code> 来根据接口，获取所有的实现类；因此我们的spi实现，需要满足jdk定义的这一套规范</p>
</blockquote>
<p>具体的代码业务逻辑非常简单，大致流程如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (<span class="keyword">null</span> == spiInterfaceType) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"common cannot be null..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!spiInterfaceType.isInterface()) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"common class:"</span> + spiInterfaceType + <span class="string">" must be interface!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!withSpiAnnotation(spiInterfaceType)) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"common class:"</span> + spiInterfaceType + <span class="string">" must have the annotation of @Spi"</span>);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">ServiceLoader&lt;T&gt; serviceLoader = ServiceLoader.load(spiInterfaceType);</span><br><span class="line"><span class="keyword">for</span>(T spiImpl: serviceLoader) &#123;</span><br><span class="line">    <span class="comment">// xxx</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ul>
<li>因为使用了jdk的标准，因此每定义一个spi接口，必须在  <code>META_INF.services</code> 下新建一个文件， 文件名为包含包路径的spi接口名， 内部为包含包路径的实现类名</li>
<li>每个spi接口，要求必须有 <code>@Spi</code> 注解</li>
<li>Spi接口必须是 <code>interface</code> 类型， 不支持抽象类和类的方式</li>
</ul>
<h4 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h4><p>虽然这里直接使用了spi的规范，我们其实完全可以自己定义标准的，只要能将这个接口的所有实现类找到， 怎么实现都可以由你定义</p>
<p>如使用spring框架后，可以考虑通过   <code>applicationContext.getBeansOfAnnotaion(xxx )</code> 来获取所有的特定注解的bean，这样就可以不需要自己新建一个文件，来存储spi接口和其实现类的映射关系了</p>
<h4 id="构建spi实现的关系表"><a href="#构建spi实现的关系表" class="headerlink" title="构建spi实现的关系表"></a>构建spi实现的关系表</h4><p>上面获取了spi实现类，显然我们的目标并不局限于简单的获取实现类，在获取实现类之后，还需要解析其中的 <code>@SpiConf</code> 注解信息，用于表示要选择这个实现，必须满足什么样的条件</p>
<p><code>SpiImplWrapper</code> :  spi实现类，以及定义的各种条件的封装类</p>
<p>注解的解析过程流程如下:</p>
<ul>
<li>name:    注解定义时，采用定义的值； 否则采用简单类名 （因此一个系统中不允许两个实现类同名的情况）</li>
<li>order： 优先级， 注解定义时，采用定义的值；未定义时采用默认；</li>
<li>params: 参数约束条件， 会取类上和方法上的并集（原则上要求类上的约束和方法上的约束不能冲突）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">List&lt;SpiImplWrapper&lt;T&gt;&gt; spiServiceList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析注解</span></span><br><span class="line">spiConf = t.getClass().getAnnotation(SpiConf.class);</span><br><span class="line">  Map&lt;String, String&gt; map;</span><br><span class="line">  <span class="keyword">if</span> (spiConf == <span class="keyword">null</span>) &#123; <span class="comment">// 没有添加注解时， 采用默认的方案</span></span><br><span class="line">      implName = t.getClass().getSimpleName();</span><br><span class="line">      implOrder = SpiImplWrapper.DEFAULT_ORDER;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 参数选择器时, 要求spi实现类必须有 @SpiConf 注解, 否则选择器无法获取校验条件参数</span></span><br><span class="line">      <span class="keyword">if</span> (currentSelector.getSelector() <span class="keyword">instanceof</span> ParamsSelector) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"spiImpl must contain annotation @SpiConf!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      map = Collections.emptyMap();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      implName = spiConf.name();</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.isBlank(implName)) &#123;</span><br><span class="line">          implName = t.getClass().getSimpleName();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      implOrder = spiConf.order() &lt; <span class="number">0</span> ? SpiImplWrapper.DEFAULT_ORDER : spiConf.order();</span><br><span class="line"></span><br><span class="line">      map = parseParms(spiConf.params());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加一个类级别的封装类</span></span><br><span class="line">  spiServiceList.add(<span class="keyword">new</span> SpiImplWrapper&lt;&gt;(t, implOrder, implName, map));</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ------------</span></span><br><span class="line">  <span class="comment">// 解析参数的方法</span></span><br><span class="line">  </span><br><span class="line">   <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">parseParms</span><span class="params">(String[] params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (params.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(params.length);</span><br><span class="line">        String[] strs;</span><br><span class="line">        <span class="keyword">for</span> (String param : params) &#123;</span><br><span class="line">            strs = StringUtils.split(param, <span class="string">":"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (strs.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                map.put(strs[<span class="number">0</span>].trim(), strs[<span class="number">1</span>].trim());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strs.length == <span class="number">1</span>) &#123;</span><br><span class="line">                map.put(strs[<span class="number">0</span>].trim(), <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-初始化选择器"><a href="#2-初始化选择器" class="headerlink" title="2. 初始化选择器"></a>2. 初始化选择器</h3><blockquote>
<p>我们的选择器会区分为两类，一个是类上定义的选择器， 一个是方法上定义的选择器； 在自适应的使用方式中，方法上定义的优先级 &gt; 类上定义</p>
</blockquote>
<p>简单来讲，初始化选择器，就是扫一遍SPI接口中的注解，实例化选择器后，缓存住对应的结果, 实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">* 选择器, 根据条件, 选择具体的 SpiImpl;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> SelectorWrapper currentSelector;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 自适应时, 方法对应的选择器</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, SelectorWrapper&gt; currentMethodSelector;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 每一个 SpiLoader 中, 每种类型的选择器, 只保存一个实例</span></span><br><span class="line"><span class="comment">* 因此可以在选择器中, 如&#123;<span class="doctag">@link</span> ParamsSelector&#125; 对spiImplMap进行处理并缓存结果</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> ConcurrentHashMap&lt;Class, SelectorWrapper&gt; selectorInstanceCacheMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   Spi ano = spiInterfaceType.getAnnotation(Spi.class);</span><br><span class="line">   <span class="keyword">if</span> (ano == <span class="keyword">null</span>) &#123;</span><br><span class="line">       currentSelector = initSelector(DefaultSelector.class);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       currentSelector = initSelector(ano.selector());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   Method[] methods = <span class="keyword">this</span>.spiInterfaceType.getMethods();</span><br><span class="line">   currentMethodSelector = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">   SelectorWrapper temp;</span><br><span class="line">   <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!method.isAnnotationPresent(SpiAdaptive.class)) &#123;</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       temp = initSelector(method.getAnnotation(SpiAdaptive.class).selector());</span><br><span class="line">       <span class="keyword">if</span> (temp == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       currentMethodSelector.put(method.getName(), temp);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> SelectorWrapper <span class="title">initSelector</span><span class="params">(Class&lt;? extends ISelector&gt; clz)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 优先从选择器缓存中获取类型对应的选择器</span></span><br><span class="line">   <span class="keyword">if</span> (selectorInstanceCacheMap.containsKey(clz)) &#123;</span><br><span class="line">       <span class="keyword">return</span> selectorInstanceCacheMap.get(clz);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       ISelector selector = clz.newInstance();</span><br><span class="line">       Class paramClz = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       Type[] types = clz.getGenericInterfaces();</span><br><span class="line">       <span class="keyword">for</span> (Type t : types) &#123;</span><br><span class="line">           <span class="keyword">if</span> (t <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">               paramClz = (Class) ((ParameterizedType) t).getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Assert.check(paramClz != <span class="keyword">null</span>);</span><br><span class="line">       SelectorWrapper wrapper = <span class="keyword">new</span> SelectorWrapper(selector, paramClz);</span><br><span class="line">       selectorInstanceCacheMap.putIfAbsent(clz, wrapper);</span><br><span class="line">       <span class="keyword">return</span> wrapper;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"illegal selector defined! yous:"</span> + clz);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h4><ol>
<li><p><code>SeectorWrapper</code> 选择器封装类</p>
<p> 这里我们在获取选择器时，特意定义了一个封装类，其中包含具体的选择器对象，以及所匹配的参数类型，因此可以在下一步通过选择器获取实现类时，保证传入的参数类型合法</p>
</li>
<li><p><code>private SelectorWrapper initSelector(Class&lt;? extends ISelector&gt; clz)</code>  具体的实例化选择器的方法</p>
<p> 从实现来看，优先从选择器缓存中获取选择器对象，这样的目的是保证一个spi接口，每种类型的选择器只有一个实例；因此在自定义选择器中，你完全可以做一些选择判断的缓存逻辑，如 <code>ParamsSelector</code> 中的spi实现类的有序缓存列表</p>
</li>
<li><p><code>currentSelector</code> , <code>currentMethodSelector</code>, <code>selectorInstanceCacheMap</code> </p>
<pre><code>currentSelector:   对应的是类选择器，每个SPI接口必然会有一个，作为打底的选择器
currentMethodSelector:  方法选择器映射关系表，key为方法名，value为该方法对应的选择器； 所以spi接口中，不支持重载
selectorInstanceCacheMap: spi接口所有定义的选择器映射关系表，key为选择器类型，value是实例；用于保障每个spi接口中选择器只会有一个实例
</code></pre></li>
</ol>
<h3 id="3-获取实现类"><a href="#3-获取实现类" class="headerlink" title="3. 获取实现类"></a>3. 获取实现类</h3><blockquote>
<p>对使用者而言，最关注的就是这个接口，这里会返回我们需要的实现类（or代理）；内部的逻辑也比较清楚，首先确定选择器，然后通过选择器便利所有的实现类，把满足条件的返回即可</p>
</blockquote>
<p>从上面的描述可以看到，主要分为两步</p>
<ol>
<li>获取选择器</li>
<li>根据选择器，遍历所有的实现类，找出匹配的返回</li>
</ol>
<h4 id="获取选择器"><a href="#获取选择器" class="headerlink" title="获取选择器"></a>获取选择器</h4><p>初始化选择器之后，我们会有 <code>currentSelector</code> , <code>currentMethodSelector</code> 两个缓存</p>
<ul>
<li>静态确定spi实现时，直接用  <code>currentSelector</code> 即可 （spi接口中所有方法都公用类定义选择器）</li>
<li>动态适配时， 根据方法名在 <code>currentMethodSelector</code> 中获取选择器，如果没有，则表示该方法没有<code>@SpiAdaptive</code>注解，直接使用类的选择器 <code>currentMethodSelector</code> 即可</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态适配时，获取方法对应对应的selector实现逻辑</span></span><br><span class="line">SelectorWrapper selector = currentMethodSelector.get(methodName);</span><br><span class="line"><span class="keyword">if</span> (selector == <span class="keyword">null</span>) &#123; <span class="comment">// 自适应方法上未定义选择器, 则默认继承类的</span></span><br><span class="line">  selector = currentSelector;</span><br><span class="line">  currentMethodSelector.putIfAbsent(methodName, selector);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!selector.getConditionType().isAssignableFrom(conf.getClass())) &#123; <span class="comment">// 选择器类型校验</span></span><br><span class="line">  <span class="keyword">if</span> (!(conf <span class="keyword">instanceof</span> String)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"conf spiInterfaceType should be sub class of ["</span> + currentSelector.getConditionType() + <span class="string">"] but yours:"</span> + conf.getClass());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 参数不匹配时，且传入的参数为String类型， 则尝试使用默认选择器进行兼容（不建议在实现时，出现这种场景）</span></span><br><span class="line">  selector = DEFAULT_SELECTOR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="选择实现类"><a href="#选择实现类" class="headerlink" title="选择实现类"></a>选择实现类</h4><p>这个的主要逻辑就是遍历所有的实现类，判断是否满足选择器的条件，将第一个找到的返回即可，所有的业务逻辑都在 <code>ISelector</code> 中实现，如下面给出的默认选择器，根据name来获取实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认的根据name 获取具体的实现类</span></span><br><span class="line"><span class="comment"> * &lt;p/&gt;</span></span><br><span class="line"><span class="comment"> * Created by yihui on 2017/5/24.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSelector</span> <span class="keyword">implements</span> <span class="title">ISelector</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;K&gt; <span class="function">K <span class="title">selector</span><span class="params">(Map&lt;String, SpiImplWrapper&lt;K&gt;&gt; map, String name)</span> <span class="keyword">throws</span> NoSpiMatchException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"spiName should not be empty!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (map == <span class="keyword">null</span> || map.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"no impl spi!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!map.containsKey(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSpiMatchException(<span class="string">"no spiImpl match the name you choose! your choose is: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map.get(name).getSpiImpl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="流程说明"><a href="#流程说明" class="headerlink" title="流程说明"></a>流程说明</h2><blockquote>
<p>上面主要就各个点单独的进行了说明，看起来可能比较分散，看完之后可能没有一个清晰的流程，这里就整个实现的流程顺一遍，主要从使用者的角度出发，当定义了一个SPI接口后，到获取spi实现的过程中，上面的这些步骤是怎样串在一起的</p>
</blockquote>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p>先拿简单的静态获取SPI实现流程说明（动态的其实差不多，具体的差异下一篇说明），先看下这种用法的使用姿势</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Spi</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPrint</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(String str)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilePrint</span> <span class="keyword">implements</span> <span class="title">IPrint</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"file print: "</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsolePrint</span> <span class="keyword">implements</span> <span class="title">IPrint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"console print: "</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPrint</span><span class="params">()</span> <span class="keyword">throws</span> NoSpiMatchException </span>&#123;</span><br><span class="line">   SpiLoader&lt;IPrint&gt; spiLoader = SpiLoader.load(IPrint.class);</span><br><span class="line">   IPrint print = spiLoader.getService(<span class="string">"ConsolePrint"</span>);</span><br><span class="line">   print.print(<span class="string">"console----&gt;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="SpiLoader-lt-IPrint-gt-spiLoader-SpiLoader-load-IPrint-class"><a href="#SpiLoader-lt-IPrint-gt-spiLoader-SpiLoader-load-IPrint-class" class="headerlink" title="SpiLoader&lt;IPrint&gt; spiLoader = SpiLoader.load(IPrint.class);"></a><code>SpiLoader&lt;IPrint&gt; spiLoader = SpiLoader.load(IPrint.class);</code></h4><p>这行代码触发的action 主要是初始化所有的选择器, 如下图</p>
<ul>
<li>首先从缓存中查</li>
<li>是否已经初始化过了有则直接返回；</li>
<li>缓存中没有，则进入new一个新的对象出来<ul>
<li>解析类上注解 <code>@Spi</code>，初始化 <code>currentSelector</code> </li>
<li>解析所有方法的注解 <code>@SpiAdaptive</code> ， 初始化 <code>currentMethodSelector</code></li>
</ul>
</li>
<li>塞入缓存，并返回</li>
</ul>
<p><img src="https://static.oschina.net/uploads/img/201705/27140821_19ee.png" alt="https://static.oschina.net/uploads/img/201705/27140821_19ee.png"></p>
<h4 id="IPrint-print-spiLoader-getService-quot-ConsolePrint-quot"><a href="#IPrint-print-spiLoader-getService-quot-ConsolePrint-quot" class="headerlink" title="IPrint print = spiLoader.getService(&quot;ConsolePrint&quot;);"></a><code>IPrint print = spiLoader.getService(&quot;ConsolePrint&quot;);</code></h4><p>根据name获取实现类，具体流程如下</p>
<ul>
<li>判断是否加载过所有实现类 <code>spiImplClassCacheMap</code></li>
<li>没有加载，则重新加载所有的实现类<ul>
<li>通过jdk的 <code>ServiceLoader.load()</code> 方法获取所有的实现类</li>
<li>遍历实现类，根据 <code>@SpiConf</code> 注解初始化参数，封装 <code>SpiImplWrapper</code>对象</li>
<li>保存封装的 <code>SpiImplWrapper</code>对象到缓存</li>
</ul>
</li>
<li>执行 <code>currentSelector.select()</code> 方法，获取匹配的实现类</li>
</ul>
<p><img src="https://static.oschina.net/uploads/img/201705/27150620_EOUL.png" alt="https://static.oschina.net/uploads/img/201705/27150620_EOUL.png"></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="博客系列链接："><a href="#博客系列链接：" class="headerlink" title="博客系列链接："></a>博客系列链接：</h3><ul>
<li><a href="/hexblog/2018/05/30/SPI%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%B9%8B%E6%97%85%E5%9B%9B%EF%BC%9A%E4%BD%BF%E7%94%A8%E6%B5%8B%E8%AF%95/">SPI框架实现之旅四：使用测试</a></li>
<li><a href="/hexblog/2018/05/30/SPI%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%B9%8B%E6%97%85%E4%B8%89%EF%BC%9A%E5%AE%9E%E7%8E%B0%E8%AF%B4%E6%98%8E/u">SPI框架实现之旅三：实现说明</a></li>
<li><a href="/hexblog/2018/05/30/SPI%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%B9%8B%E6%97%85%E4%BA%8C%EF%BC%9A%E6%95%B4%E4%BD%93%E8%AE%BE%E8%AE%A1/">SPI框架实现之旅二：整体设计</a></li>
<li><a href="/hexblog/2017/05/29/SPI%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%B9%8B%E6%97%85%E4%B8%80%EF%BC%9A%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D/">SPI框架实现之旅一：背景介绍</a></li>
</ul>
<h3 id="项目-QuickAlarm"><a href="#项目-QuickAlarm" class="headerlink" title="项目: QuickAlarm"></a>项目: QuickAlarm</h3><ul>
<li>项目地址： <a href="https://github.com/liuyueyi/quick-spi" target="_blank" rel="noopener">Quick-SPI</a></li>
<li>博客地址： <a href="https://liuyueyi.github.io/hexblog/" target="_blank" rel="noopener">小灰灰Blog</a></li>
</ul>
<h3 id="个人博客：-Z-blog"><a href="#个人博客：-Z-blog" class="headerlink" title="个人博客： Z+|blog"></a>个人博客： <a href="https://liuyueyi.github.io/hexblog" target="_blank" rel="noopener">Z+|blog</a></h3><p>基于hexo + github pages搭建的个人博客，记录所有学习和工作中的博文，欢迎大家前去逛逛</p>
<h3 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h3><p>尽信书则不如，已上内容，纯属一家之言，因本人能力一般，见识有限，如发现bug或者有更好的建议，随时欢迎批评指正，我的微博地址: <a href="https://weibo.com/p/1005052169825577/home" target="_blank" rel="noopener">小灰灰Blog</a></p>
<h3 id="扫描关注"><a href="#扫描关注" class="headerlink" title="扫描关注"></a>扫描关注</h3><p><img src="https://s17.mogucdn.com/mlcdn/c45406/180209_74fic633aebgh5dgfhid2fiiggc99_1220x480.png" alt="QrCode"></p>
</div><div class="tags"><a href="/hexblog/tags/Java/">Java</a><a href="/hexblog/tags/SPI/">SPI</a></div><div style="text-align:center"><br><button style="color:red;background-color: #f44336;border: none;border-radius: 8px;color: white;padding: 10px 30px;text-align: center;text-decoration: none;font-size: 16px;" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">打赏</button><br><span style="display: block;color: #9d9d9d;font: 14px/2 &amp;quot;Microsoft Yahei&amp;quot;">如果觉得我的文章对您有帮助，请随意打赏。</span><br><div id="QR" style="display: none; margin-top: 20px;" class="row"><div id="wechat" style="display: inline-block;width:44%;margin-left:6%;text-align:center;"><a href="https://s3.mogucdn.com/mlcdn/c45406/180104_50136i33id9e49j1f7k2e219e3ldf_800x798.png"><img src="https://s3.mogucdn.com/mlcdn/c45406/180104_50136i33id9e49j1f7k2e219e3ldf_800x798.png" alt="WeChat Pay" style="width:80%;height:80%;max-height:200px;max-width:200px"></a><p style="text-align:center">微信打赏</p></div><div id="alipay" style="display: inline-block;width:44%;text-align:center"><a href="https://s3.mogucdn.com/mlcdn/c45406/180104_0e6afl33b23lacj6ji2d7d060aiak_798x800.png"><img src="https://s3.mogucdn.com/mlcdn/c45406/180104_0e6afl33b23lacj6ji2d7d060aiak_798x800.png" alt="Alipay" style="width:80%;height:80%;max-height:200px;max-width:200px"></a><p style="text-align:center">支付宝打赏</p></div></div></div><div class="article-footer-copyright"><url><li>版权声明：本文由<b> 一灰灰 </b><span>发表于</span><a href="/hexblog/"> 一灰灰Blog </a></li><li>转载声明：自由转载-非商用-非衍生-保持署名，非商业转载请注明作者及出处，商业转载请联系作者本人。</li><li id="blogTitleCp">文章标题：<a>2. SPI框架实现之旅二：整体设计</a></li><li>文章链接：<a id="blogLink"></a><script>var blogLink = decodeURI(window.location.href);
var doc = document.getElementById('blogLink');
doc.setAttribute("href", blogLink);
doc.innerHTML=blogLink;</script></li></url></div><div class="post-share"><div><script src="https://s3.mogucdn.com/mlcdn/c45406/1520387600580_dom-to-image.min.js" charset="utf-8"></script><script>var url;
console.log('start--->',(new Date()).valueOf());
domtoimage.toPng(document.getElementsByClassName('layout-l')[0])
    .then(function (dataUrl) {
        url = dataUrl;
        console.log('end--->',(new Date()).valueOf());
     })
    .catch(function (error) {});
function link() {
    var title = document.getElementById('blogTitleCp').children[0].innerText;
    console.log("blog title: ", title);
    window.open().document.write('<html><head><title>'+ title + '</title></head><body><div style=\'text-align:center\' ><a download="一灰灰Blog博文_' + title + '.png" href="'+url+'"><img title="点击下载博文图：' + title + '" src="' + url + '" /></a></div></body></html>');
}</script><span style="float:center;font-size:20px;font-weight:solid;color:gray">渲染：</span><a id="saveImg" href="javascript:void(0)" onclick="link()" class="save_img">保存图片</a></div><div id="share" class="soshm social-share"><span style="float:center;font-size:20px;font-weight:solid;color:gray">分享：</span></div></div><div class="post-nav"><a href="/hexblog/2017/05/29/SPI框架实现之旅三：实现说明/" class="pre">3. SPI框架实现之旅三：实现说明</a><a href="/hexblog/2017/05/26/SPI框架实现之旅一：背景介绍/" class="next">1. SPI框架实现之旅一：背景介绍</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNDY0OC8xMTE4NQ=="></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#整体设计"><span class="toc-text">整体设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#设计思路"><span class="toc-text">设计思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基础类说明"><span class="toc-text">基础类说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Selector-选择器"><span class="toc-text">1. Selector 选择器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#接口定义如下"><span class="toc-text">接口定义如下:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#结合上面的接口定义，我们可以考虑下，选择器应该如何工作？"><span class="toc-text">结合上面的接口定义，我们可以考虑下，选择器应该如何工作？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#框架中会提供两种基本的选择器实现，"><span class="toc-text">框架中会提供两种基本的选择器实现，</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义实现"><span class="toc-text">自定义实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Spi-注解"><span class="toc-text">2. Spi 注解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定义如下"><span class="toc-text">定义如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#说明"><span class="toc-text">说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-SpiAdaptive-注解"><span class="toc-text">3. SpiAdaptive 注解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#接口说明"><span class="toc-text">接口说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#说明-1"><span class="toc-text">说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-SpiConf-注解"><span class="toc-text">4. SpiConf 注解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定义如下-1"><span class="toc-text">定义如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#说明-2"><span class="toc-text">说明</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SPI加载器"><span class="toc-text">SPI加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-加载spi实现类"><span class="toc-text">1. 加载spi实现类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注意"><span class="toc-text">注意</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拓展"><span class="toc-text">拓展</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构建spi实现的关系表"><span class="toc-text">构建spi实现的关系表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-初始化选择器"><span class="toc-text">2. 初始化选择器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#说明-3"><span class="toc-text">说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-获取实现类"><span class="toc-text">3. 获取实现类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取选择器"><span class="toc-text">获取选择器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#选择实现类"><span class="toc-text">选择实现类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流程说明"><span class="toc-text">流程说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#流程图"><span class="toc-text">流程图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SpiLoader-lt-IPrint-gt-spiLoader-SpiLoader-load-IPrint-class"><span class="toc-text">SpiLoader&lt;IPrint&gt; spiLoader = SpiLoader.load(IPrint.class);</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPrint-print-spiLoader-getService-quot-ConsolePrint-quot"><span class="toc-text">IPrint print = spiLoader.getService(&quot;ConsolePrint&quot;);</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他"><span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#博客系列链接："><span class="toc-text">博客系列链接：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#项目-QuickAlarm"><span class="toc-text">项目: QuickAlarm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#个人博客：-Z-blog"><span class="toc-text">个人博客： Z+|blog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#声明"><span class="toc-text">声明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扫描关注"><span class="toc-text">扫描关注</span></a></li></ol></li></ol></li></ol></div><div class="widget"><div class="widget-title"><a href="/hexblog/about/"><i class="fa fa-user"> 一灰灰Blog</i></a></div><ul class="post-list"><li style="text-align:center"><img src="//s3.mogucdn.com/mlcdn/c45406/170419_637cgff527i8k9k8h512iaf36cdia_600x600.jpg" style="max-width:80px;radius:80px"/><p style="text-align:center">好好学习，天天搬砖</p><hr style="height:0.1px;border:none;border-top:1px dashed #0066CC;"/></li><li class="post-list-item"><a href="mailto:bangzewu@126.com" title="126邮箱" class="post-list-link"><i class="fa fa-email">  bangzewu@126.com</i></a></li><li class="post-list-item"><a href="//github.com/liuyueyi" title="Git主页" target="_blank" class="post-list-link"><i class="fa fa-github">  github.com/liuyueyi</i></a></li><li class="post-list-item"><a href="" title="QQ" class="post-list-link"><i class="fa fa-you">  QQ:3302797840</i></a></li><li class="post-list-item"><a href="//weibo.com/p/1005052169825577/home" title="微博主页" target="_blank" class="post-list-link"><i class="fa fa-weibo">  微博:小灰灰Blog</i></a></li><li class="post-list-item"><i class="fa fa-weixin">  微信公众号</i></li><li style="text-align:center" class="post-list-item"><img src="https://s10.mogucdn.com/mlcdn/c45406/171229_1cgld3igbelkbc70cd8af1j3809kb_150x150.jpg"/></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/16/test/">test</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/15/JVM学习之垃圾回收机制/">JVM学习之垃圾回收机制</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/15/熔断Hystrix使用尝鲜/">熔断Hystrix使用尝鲜</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/13/JVM学习之内存结构/">JVM学习之内存结构</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/13/JVM学习之Java类的加载机制/">JVM学习之Java类的加载机制</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/12/Chrome插件之DomToImage实现/">Chrome插件之DomToImage实现</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/08/JQuery-实战笔记一/">JQuery 实战笔记一</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/06/Java并发学习之线程池ThreadPoolExecutor的小结/">Java并发学习之线程池ThreadPoolExecutor的小结</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/05/报警系统QuickAlarm之默认报警规则扩展/">7. 报警系统QuickAlarm之默认报警规则扩展</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/02/12/借助GitHub搭建属于自己的maven仓库教程/">借助GitHub搭建属于自己的maven仓库教程</a></li></ul></div><div class="widget"><div class="widget-title"><script>function showOrHide(cname, expandId) {
  var nodes = document.getElementsByClassName(cname);
  var style = nodes[0].style.display;
  var s = 'none';
  if(style == 'none' || style == '' || style == ' ') {
    s = 'block'
  }
  if(s === 'none') {
    document.getElementById(expandId).innerText = ' 点击展开 ';
  } else {
    document.getElementById(expandId).innerText = ' 点击隐藏 ';
  }
  for (var i in nodes) {
     if(typeof(nodes[i]) == 'object') {
        nodes[i].style.display = s;
     }
  }
}</script><a title="点击展开或隐藏分类" href="javascript:void(0)" onclick="showOrHide('category-list-child', 'category-expand')"><i class="fa fa-gui"> 分类(42)</i><span id="category-expand" style="font-size:12px;color:red"> 点击展开 </span></a></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/工作/">工作</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/工作/技术尝鲜/">技术尝鲜</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/">技术</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Android/">Android</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Android/一封/">一封</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/BugFix/">BugFix</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/BugFix/Java/">Java</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/BugFix/Java/Image/">Image</a><span class="category-list-count">2</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/">Java</a><span class="category-list-count">17</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/JDK/">JDK</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/JVM/">JVM</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/JavaWeb/">JavaWeb</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/Spring/">Spring</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/Tool/">Tool</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/并发/">并发</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Quick系列项目/">Quick系列项目</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Quick系列项目/QuickAlarm/">QuickAlarm</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Quick系列项目/QuickSpi/">QuickSpi</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Redis/">Redis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Shell/">Shell</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Shell/Git/">Git</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Shell/Git/Maven/">Maven</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Shell/Nginx/">Nginx</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Shell/环境搭建/">环境搭建</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/前端/">前端</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/前端/Chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/前端/Jquery/">Jquery</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/杂记/">杂记</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/杂记/idea/">idea</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/生活/">生活</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/生活/随笔/">随笔</a><span class="category-list-count">1</span></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签墙(42)</i></div><div class="tagcloud"><!--!= tagcloud({min_font: 15, max_font: 15, amount: 100, orderby: 'count'})--><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/JavaWeb/">JavaWeb</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/JVM/">JVM</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/日记/">日记</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Android/">Android</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/一封/">一封</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/RelativeLayout/">RelativeLayout</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/CountDownTimer/">CountDownTimer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Bugfix/">Bugfix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Java/">Java</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/batik/">batik</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Png/">Png</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Gitbook/">Gitbook</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Centos/">Centos</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/教程/">教程</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Chrome/">Chrome</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/工具/">工具</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/并发/">并发</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/ForkJoin/">ForkJoin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/笔记/">笔记</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Reflect/">Reflect</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Jquery/">Jquery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/ClassLoader/">ClassLoader</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/双亲委托/">双亲委托</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/内存结构/">内存结构</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/垃圾回收/">垃圾回收</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Filter/">Filter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Servlet/">Servlet</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/JDK/">JDK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Initialize/">Initialize</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/File/">File</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/ScheduledExecutorService/">ScheduledExecutorService</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/clone/">clone</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/beancopy/">beancopy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/ThreadPoolExecutor/">ThreadPoolExecutor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/配置/">配置</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Redis/">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/distributeLock/">distributeLock</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/SPI/">SPI</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/整体设计/">整体设计</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/使用手册/">使用手册</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Spring/">Spring</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/RequestParam/">RequestParam</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Jsonp/">Jsonp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/CORS/">CORS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Exception/">Exception</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Response/">Response</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Github/">Github</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Maven/">Maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/BugFix/">BugFix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/BufferedImage/">BufferedImage</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Jpeg/">Jpeg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Okhttp/">Okhttp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/QuickAlarm/">QuickAlarm</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/hystrix/">hystrix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/随笔/">随笔</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档(42)</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2018/03/">三月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2018/02/">二月 2018</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2018/01/">一月 2018</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2017/12/">十二月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2017/05/">五月 2017</a><span class="archive-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 更多链接</i></div><ul style="padding-top:10px"></ul><li style="padding-top:2px"><a href="//my.oschina.net/u/566591" title="开源中国" target="_blank">开源中国</a></li><li style="padding-top:2px"><a href="//blog.csdn.net/liuyueyi25" title="CSDN" target="_blank">CSDN</a></li><li style="padding-top:2px"><a href="//www.jianshu.com/u/5902ab08e670" title="简书" target="_blank">简书</a></li><li style="padding-top:2px"><a href="//juejin.im/user/5a2a4b095188252ae93adbbf/posts" title="掘金" target="_blank">掘金</a></li><li style="padding-top:2px"><a href="//www.toutiao.com/c/user/69862071663/#mid=1579653107239950" title="头条" target="_blank">头条</a></li></div><div class="widget"><div class="widget-title"><i onclick="var qr = document.getElementById('qrcode'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}" style="cursor:pointer" class="fa fa-hit"> 点赞(点击展开)</i></div><ul id="qrcode" style="display:none;" class="post-list"><br/><li style="text-align:center" class="post-list-item"><a href="https://s3.mogucdn.com/mlcdn/c45406/180104_50136i33id9e49j1f7k2e219e3ldf_800x798.png" target="_blank"><img src="https://s3.mogucdn.com/mlcdn/c45406/180104_50136i33id9e49j1f7k2e219e3ldf_800x798.png" alt="WeChat Pay" style="width:75%"/><br/><p style="text-align:center">微信打赏</p></a></li><li style="text-align:center" class="post-list-item"><a href="https://s3.mogucdn.com/mlcdn/c45406/180104_0e6afl33b23lacj6ji2d7d060aiak_798x800.png" target="_blank"><img src="https://s3.mogucdn.com/mlcdn/c45406/180104_0e6afl33b23lacj6ji2d7d060aiak_798x800.png" alt="Alipay" style="width:75%"/><br/><p style="text-align:center">支付宝打赏</p></a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="https://zbang.online/webs"><img src="//s3.mogucdn.com/mlcdn/c45406/170419_637cgff527i8k9k8h512iaf36cdia_600x600.jpg" style="max-width: 44px;border-radius:44px"></a></p><p><a href="https://github.com/liuyueyi" target="_blank">GitHub</a> |  <a href="mailto:bangzewu@126.com">email</a> |  <a href="/hexblog/about/">关于 |</a><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p></p><p><span> Copyright &copy;<a href="/hexblog/." rel="nofollow">YiHui.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?028d9e53f991d9739ecc7cc42e13c500";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/hexblog/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/hexblog/js/toctotop.js?v=2.0.1" async></script><script src="https://s3.mogucdn.com/mlcdn/c45406/1520407228303_social-share.min.js" charset="utf-8"></script><link rel="stylesheet" href="https://s3.mogucdn.com/mlcdn/c45406/1518422561591_share.min.css"><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>
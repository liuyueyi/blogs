<!DOCTYPE html><html lang="zh-CN"><head><meta name="google-site-verification" content="PR6S72-htn-N1oDn9ENMcwi5niLKk0uebDzmRS-oivs"><meta property="wb:webmaster" content="320520520031fedd"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="好好学习，努力搬砖，天天吃草"><title>图片合成支持的前世今生 | 一灰灰Blog</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/hexblog/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/hexblog/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/hexblog/favicon.ico"><link rel="bookmark" href="/hexblog/favicon.ico"><link rel="apple-touch-icon" href="/hexblog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/hexblog/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">图片合成支持的前世今生</h1><a id="logo" href="/hexblog/.">一灰灰Blog</a><p style="font-size:18px" class="description">一灰灰的个人博客网站</p></div><div id="nav-menu"><a href="/hexblog/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/hexblog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/hexblog/about/"><i class="fa fa-user"> 关于</i></a><a href="http://liuyueyi.gitee.io/zweb/#/index"><i class="fa fa-rss"> 网站</i></a><a href="http://liuyueyi.gitee.io/mweb/#/"><i class="fa fa-you"> 古诗选</i></a><hr><br><div id="nav-sub-menu"><a href="/hexblog/categories/技术"><i class="fa fa-right"> 技术</i></a><a href="/hexblog/categories/工作"><i class="fa fa-right"> 工作</i></a><a href="/hexblog/categories/生活"><i class="fa fa-right"> 生活</i></a><a href="/hexblog/categories/杂记"><i class="fa fa-right"> 杂记</i></a></div></div>
<div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="search"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/hexblog/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">图片合成支持的前世今生 <span style="font-size:14px;color:#40759b;font-style:italic;border-bottom: 1px solid #e5e5e5;">&gt;&gt;&gt; by 一灰灰Blog</span></h1><div class="post-meta"><a href="/hexblog/2017/12/17/图片合成支持的前世今生/#saveImg" class="saveImg-icon"></a><a href="/hexblog/2017/12/17/图片合成支持的前世今生/#comments" class="comment-count"></a><p><span class="date">Dec 17, 2017</span><span><a href="/hexblog/categories/杂记/" class="category">杂记</a><a href="/hexblog/categories/杂记/吐槽/" class="category">吐槽</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="图片合成的前世今生"><a href="#图片合成的前世今生" class="headerlink" title="图片合成的前世今生"></a>图片合成的前世今生</h2><blockquote>
<p>作为一个后端，为什么要做图片合成？为什么要实现类xml标记语言的渲染？</p>
</blockquote>
<p>本片博文准备详细的记录一下，一个java后端如何去支持图片合成，在这个过程中采用了哪些猥琐的方案，又遇到了哪些鬼畜的问题</p>
<a id="more"></a>
<h2 id="I-背景"><a href="#I-背景" class="headerlink" title="I. 背景"></a>I. 背景</h2><h3 id="0-无聊的技术研究"><a href="#0-无聊的技术研究" class="headerlink" title="0. 无聊的技术研究"></a>0. 无聊的技术研究</h3><p>最开始萌发支持图片合成的想法，那时候还是在做二维码的时候，用了一些awt的画图工具，感觉还挺有意思的，这是一个和当前的电商主流完全不搭边的技术分支，开始用的时候感慨，这东西牛逼了，什么都可以干（虽然操作非常不友好），再加上用到有道云，它的会员功能支持加功能将笔记以图片方式生成，所以就有个想法，java后端能不能支持markdown输出图片呢？</p>
<h3 id="1-蛋疼的小程序"><a href="#1-蛋疼的小程序" class="headerlink" title="1. 蛋疼的小程序"></a>1. 蛋疼的小程序</h3><p>不是一个专业的小程序开发者，虽然写过一个小程序，但是很多特性依然不知道；</p>
<p>突然很多前端突然提了这么一个需求，要求后端支持图片合成，用于分享到朋友圈</p>
<p>至于原因:</p>
<ul>
<li>有的说小程序没有提供截屏接口</li>
<li>小程序不支持绘图（这个我不太确定真实性）</li>
<li>小程序绘图的api不可控（如果他们有bug，我们就没法玩了；对此我的看法是，你整个东西都是在小程序的体系里了，要是有个严重bug，那我们的小程序干脆就不玩好了…）</li>
<li>前端这么多，每个人都去绘制一遍低效，有个后端通用的，各个平台都释放了，都可以直接用… (对此我也没啥好说的，如果我是前端我也挺这一点；然而我不是，所以我拒绝😢)</li>
</ul>
<p><strong>声明</strong></p>
<p>上面括号的内容纯粹是个人吐槽，没有任何偏向性，</p>
<h3 id="2-开动"><a href="#2-开动" class="headerlink" title="2. 开动"></a>2. 开动</h3><p>有需求了，就必须去支持了，而且从技术角度出发，这是一个非常有意思的点，新的挑战，可以一试</p>
<h2 id="II-技术尝试"><a href="#II-技术尝试" class="headerlink" title="II. 技术尝试"></a>II. 技术尝试</h2><p>为了支持这个需求，尝试了不少的手段，接下来一一说明，当然由于个人见识有限，最终选择的也不一定是啥好东西，目前也只是处于可用的状态，离友好支持，还比较遥远</p>
<h3 id="0-java的html渲染库"><a href="#0-java的html渲染库" class="headerlink" title="0. java的html渲染库"></a>0. java的html渲染库</h3><blockquote>
<p>最先想到的就是这个，有没有直接可以渲染的库，大Java号称是在github上拥有最多开源工具的语言</p>
</blockquote>
<p>查了一些开源库，也主动去尝试过一些，下面给出使用姿势</p>
<h4 id="a-html2image"><a href="#a-html2image" class="headerlink" title="a. html2image"></a>a. html2image</h4><p>直接在Github上搜，找一个最多star的就可以了，测试的框架 </p>
<ul>
<li><a href="https://github.com/hkirk/java-html2image" target="_blank" rel="noopener">java-html2image</a></li>
</ul>
<p>接入及测试方式</p>
<p>pmo 依赖引入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>gui.ava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>html2image<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>yoava<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>AOL yoava<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://yoava.artifactoryonline.com/yoava/repo<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试代码也比较简单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRenderHtml</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String url = <span class="string">"http://www.baidu.com"</span>;</span><br><span class="line">    HtmlImageGenerator generator = <span class="keyword">new</span> HtmlImageGenerator();</span><br><span class="line">    generator.loadUrl(url);</span><br><span class="line"></span><br><span class="line">    BufferedImage img = generator.getBufferedImage();</span><br><span class="line">    System.out.println(<span class="string">"---"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是看输出的图片了，看下是否和我们预期相同</p>
<p><img src="http://s2.mogucdn.com/mlcdn/c45406/171217_3e12a2he6598kcj107cld089e699j_935x418.png" alt="html2img.png"></p>
<p>这个颜色，样式有点鬼畜，折腾了一番，实际验证这个框架挺不错的，就是有以下几个问题</p>
<ul>
<li>很久很久很久很久很久以前的产物了</li>
<li>没人维护</li>
<li>css样式支持不友好</li>
</ul>
<p>换个复杂点的url，比如淘宝or蘑菇街商品详情页，返回就更鬼畜了，有兴趣的童鞋可自己尝试一下</p>
<h4 id="b-xhtml渲染包"><a href="#b-xhtml渲染包" class="headerlink" title="b. xhtml渲染包"></a>b. xhtml渲染包</h4><p>这个也可以实现html渲染，又是一个老古董级别的东西，已经忘记从哪里捞出来的，最初实现markdown渲染成图片，就是采用的这个包，对简单的css的支持还算友好</p>
<p>pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--html to image render--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xhtmlrenderer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core-renderer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>R8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sourceforge.nekohtml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nekohtml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--html to image render--&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试case</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String url = <span class="string">"http://www.baidu.com"</span>;</span><br><span class="line">        BufferedImage buf = ImageRenderer.renderToImage(url, <span class="string">"/Users/yihui/html2image.pdf"</span>, <span class="number">800</span>);</span><br><span class="line">        System.out.println(<span class="string">"---"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用起来还是比较简单的，但是，上面这种直接执行，会抛异常，说访问的html有些语法有问题; 然后做了一些修改和调整，修正后的测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> DOMParser domParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    domParser = <span class="keyword">new</span> DOMParser(<span class="keyword">new</span> HTMLConfiguration());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        domParser.setProperty(<span class="string">"http://cyberneko.org/html/properties/names/elems"</span>, <span class="string">"lower"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Can't create HtmlParserImpl"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Document <span class="title">parseDocument</span><span class="params">(String content)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    domParser.parse(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(content)));</span><br><span class="line">    <span class="keyword">return</span> domParser.getDocument();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">readHtmlContent</span><span class="params">(String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    InputStream in = HttpUtil.downFile(url);</span><br><span class="line">    StringBuilder out = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> n; (n = in.read(b)) != -<span class="number">1</span>; ) &#123;</span><br><span class="line">        out.append(<span class="keyword">new</span> String(b, <span class="number">0</span>, n));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> out.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String url = <span class="string">"http://www.baidu.com"</span>;</span><br><span class="line">        Document doc = parseDocument(readHtmlContent(url));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> width = <span class="number">800</span>;</span><br><span class="line">        <span class="keyword">int</span> height = <span class="number">1024</span>;</span><br><span class="line">        Graphics2DRenderer renderer = <span class="keyword">new</span> Graphics2DRenderer();</span><br><span class="line">        renderer.setDocument(doc, doc.getDocumentURI());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        BufferedImage bufferedImage = <span class="keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">        Graphics2D graphics2D = GraphicUtil.getG2d(bufferedImage);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// do layout with temp buffer</span></span><br><span class="line">        renderer.layout(graphics2D, <span class="keyword">new</span> Dimension(width, height));</span><br><span class="line">        graphics2D.dispose();</span><br><span class="line"></span><br><span class="line">        Rectangle size = renderer.getMinimumSize();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> autoWidth = width;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> autoHeight = (<span class="keyword">int</span>) size.getHeight();</span><br><span class="line">        bufferedImage = <span class="keyword">new</span> BufferedImage(autoWidth, autoHeight, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">        Dimension dimension = <span class="keyword">new</span> Dimension(autoWidth, autoHeight);</span><br><span class="line"></span><br><span class="line">        graphics2D = GraphicUtil.getG2d(bufferedImage);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        renderer.layout(graphics2D, dimension);</span><br><span class="line">        renderer.render(graphics2D);</span><br><span class="line">        graphics2D.dispose();</span><br><span class="line">        System.out.println(<span class="string">"---------"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果输出图片为空白的页面，为啥？ 仔细去看百度的网页，发现没有dom结构，一堆的js和css代码，换个本地的html来试一下，输出效果还不错，我之前做了一个小工具，实现markdown转image，就是用的这个框架做中转，将markdown生成的html渲染为图片，当然复杂一点的css就不行了</p>
<p>相信看到这里，这个库的缺陷也好很明显了，不适合生产环境，自己玩玩还行</p>
<ul>
<li>过于古老，基本没人维护</li>
<li>对html的格式有要求</li>
<li>复杂的css没法玩</li>
<li>指定宽度也比较恶心</li>
</ul>
<hr>
<h4 id="c-借助转pdf的包"><a href="#c-借助转pdf的包" class="headerlink" title="c. 借助转pdf的包"></a>c. 借助转pdf的包</h4><p>java中，提供html转pdf的包还不少，借助这些工具，也是可以间接实现这个功能的，具体的就不贴了，可以用的不少，收钱的，免费的都有</p>
<p>推荐几个搞标记的</p>
<ul>
<li><a href="https://github.com/flyingsaucerproject/flyingsaucer" target="_blank" rel="noopener">flyingsaucer</a></li>
<li><a href="https://github.com/danfickle/openhtmltopdf" target="_blank" rel="noopener">openhtmltopdf</a></li>
<li><a href="https://github.com/itext" target="_blank" rel="noopener">itext</a></li>
</ul>
<hr>
<h4 id="d-小结"><a href="#d-小结" class="headerlink" title="d. 小结"></a>d. 小结</h4><p>基本上，没有找到合乎心意的转换包，其实有些包也不错，如果深入进去改一波，应该也能使用，然实际就是深入进去，基本上挖不动</p>
<hr>
<h3 id="1-imagemagic的合成"><a href="#1-imagemagic的合成" class="headerlink" title="1. imagemagic的合成"></a>1. imagemagic的合成</h3><p>大名鼎鼎的图片处理工具，c++的，可以提供图片的各种姿势的操作，当然也包括了图片合成，要玩这个，首先得搭建这个环境（这个成本比上面会大一点）</p>
<h4 id="a-环境准备"><a href="#a-环境准备" class="headerlink" title="a. 环境准备"></a>a. 环境准备</h4><p>简单搭建方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install libjpeg-devel</span><br><span class="line">yum install libpng-devel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 本地环境搭建</span><br><span class="line">sudo brew install jpeg</span><br><span class="line">sudo brew install libpng</span><br><span class="line">sudo brew install GraphicsMagick</span><br></pre></td></tr></table></figure>
<p>搭建完毕后，测试先是否可用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## 搭建完毕，开始测试</span><br><span class="line">gm convert input.jpg -thumbnail &apos;100x100&apos; output_1.jpg</span><br><span class="line"></span><br><span class="line">gm convert -crop 640x960+0+0 test.jpg output.jpg</span><br></pre></td></tr></table></figure>
<p>如果上面的搞不定，也可以用下面的下载包的方式安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">安装jpeg 包 `wget ftp://223.202.54.10/pub/web/php/libjpeg-6b.tar.gz`</span><br><span class="line">安装webp 包 `wget http://www.imagemagick.org/download/delegates/libwebp-0.5.1.tar.gz`</span><br><span class="line">安装png 包 `wget http://www.imagemagick.org/download/delegates/libpng-1.6.24.tar.gz`</span><br><span class="line">安装 graphicsmagick `wget http://nchc.dl.sourceforge.net/project/graphicsmagick/graphicsmagick/1.3.22/GraphicsMagick-1.3.22.tar.gz`</span><br><span class="line"></span><br><span class="line">## ----------</span><br><span class="line"></span><br><span class="line">make distclean ##  清楚上次make的东西</span><br><span class="line"></span><br><span class="line">imagemagick ：</span><br><span class="line"></span><br><span class="line">`wget http://www.imagemagick.org/download/ImageMagick.tar.gz`</span><br><span class="line"></span><br><span class="line">安装命令  `sudo ./configure; sudo make; sudo make install`</span><br><span class="line"></span><br><span class="line">裁图命令 `convert test.jpg -crop 640x960+0+0 output.jpg`</span><br></pre></td></tr></table></figure>
<p>linux 安装imagemagick 发现一直找不到 png的依赖，</p>
<p>linux 安装之后，可能有两个问题</p>
<ul>
<li><p>imagemagick 依然无法读取png图片</p>
<ul>
<li>查阅需要安装 <a href="http://pkgconfig.freedesktop.org/releases/pkg-config-0.28.tar.gz" target="_blank" rel="noopener">http://pkgconfig.freedesktop.org/releases/pkg-config-0.28.tar.gz</a></li>
</ul>
</li>
<li><p>执行 convert 提示linux shared libraries 不包含某个库 </p>
<ul>
<li>临时解决方案： export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH</li>
<li>一劳永逸的方案：<a href="https://my.oschina.net/guanyue/blog/220264" target="_blank" rel="noopener">https://my.oschina.net/guanyue/blog/220264</a><ul>
<li>vi /etc/ld.so.conf 在这个文件里加入：/usr/local/lib 来指明共享库的搜索位置 然后再执行/sbin/ldconf</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="b-java调用"><a href="#b-java调用" class="headerlink" title="b. java调用"></a>b. java调用</h4><p>当然，我们是java的后端，现在就需要用java来调用imagemagic的执行了</p>
<p>依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.im4java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>im4java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面给一个图片裁剪的测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 裁剪图片</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> imagePath 源图片路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> outPath   处理后图片路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x         起始X坐标</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> y         起始Y坐标</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> width     裁剪宽度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> height    裁剪高度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回true说明裁剪成功, 否则失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">cut</span><span class="params">(String imagePath, String outPath, <span class="keyword">int</span> x, <span class="keyword">int</span> y,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> flag;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        IMOperation op = <span class="keyword">new</span> IMOperation();</span><br><span class="line">        op.addImage(imagePath);</span><br><span class="line">        <span class="comment">/** width：裁剪的宽度 * height：裁剪的高度 * x：裁剪的横坐标 * y：裁剪纵坐标 */</span></span><br><span class="line">        op.crop(width, height, x, y);</span><br><span class="line">        op.addImage(outPath);</span><br><span class="line">        <span class="comment">// 传true到构造函数中,则表示使用GraphicMagic, 裁图时,图片大小会变</span></span><br><span class="line">        ConvertCmd convert = <span class="keyword">new</span> ConvertCmd();</span><br><span class="line">        convert.run(op);</span><br><span class="line">        flag = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        flag = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        flag = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IM4JavaException e) &#123;</span><br><span class="line">        flag = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体使用姿势就不说了，这个框架本身是支持简单的图片合成的，几张图和一下，加上文字水印啥的，主要说一下有什么问题</p>
<ul>
<li>图片合成参数不是一般的复杂，想实现一个模板的合成，这个命令可以说很难完美的写出来</li>
<li>性能一般般</li>
</ul>
<p>总得来说，这个用来做图片的基本操作还很好，真心不太合适复杂点的图片合成，分分钟虐哭</p>
<h4 id="c-其他一些不得不说的故事"><a href="#c-其他一些不得不说的故事" class="headerlink" title="c. 其他一些不得不说的故事"></a>c. 其他一些不得不说的故事</h4><p>说到imagemagic，就不得不说graphicmagic，两者基本差不多，有说法是 graphicmagic的性能要高与imagemagic，那么我们为什么选择 imagemagic</p>
<ul>
<li>graphicmagic 处理jpg图片，会有精度丢失的问题（不知道是不是我的使用姿势不对，同样的case，imagemagic不会）</li>
<li>公司的基线是支持imagemagic的</li>
</ul>
<p>很久以前写了一篇博文，就是如何利用 imagegraphic 搭建一个图片处理服务器的</p>
<ul>
<li><a href="https://my.oschina.net/u/566591/blog/778851" target="_blank" rel="noopener">im4java + imagemagic 搭建一个图片处理服务</a></li>
</ul>
<hr>
<h3 id="2-awt的绘制"><a href="#2-awt的绘制" class="headerlink" title="2. awt的绘制"></a>2. awt的绘制</h3><p>利用java的awt包，也是可以实现绘图的，而且功能也比较强大，完全可以实现各种姿势的绘图场景, 一个case如 :</p>
<p><img src="http://s3.mogucdn.com/mlcdn/c45406/171203_36j204d8e1deild5li4c116b9c137_640x340.jpg" alt="case"></p>
<p>上面这个图的合成，就是基于awt做到的，这一张图，我们需要做些什么？</p>
<ul>
<li>图片的绘制</li>
<li>圆角图片</li>
<li>文字输出</li>
<li>文字对其方式</li>
<li>直线</li>
<li>矩形</li>
<li>纯色背景</li>
</ul>
<p>一般来将，上面几种场景的支持，可以满足绝大多数的合图要求，接下来看一下是如何支持上面的几种case的</p>
<h4 id="o-接口定义"><a href="#o-接口定义" class="headerlink" title="o. 接口定义"></a>o. 接口定义</h4><p>定义一个基本的绘图单元接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDrawBO</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="a-图片-：-ImgBO"><a href="#a-图片-：-ImgBO" class="headerlink" title="a. 图片 ： ImgBO"></a>a. 图片 ： ImgBO</h4><p>图片的定义比较简单，一般只需要知道坐标，和宽高就ok了，所以我们的定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImgBO</span> <span class="keyword">implements</span> <span class="title">IDrawBO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BufferedImage image;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> w;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> h;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="b-文字：FontBO"><a href="#b-文字：FontBO" class="headerlink" title="b. 文字：FontBO"></a>b. 文字：FontBO</h4><p>文字相比较图片就有些额外的区别，有字体，样式、颜色，坐标，删除线</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FontBO</span> <span class="keyword">implements</span> <span class="title">IDrawBO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String msgs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Font font;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Color color;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> deleted = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="c-直线-LineBO"><a href="#c-直线-LineBO" class="headerlink" title="c. 直线: LineBO"></a>c. 直线: LineBO</h4><p>直线，除了我们常规的起点坐标，末尾坐标之外，颜色的设置，虚线样式也是常见的属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LineBO</span> <span class="keyword">implements</span> <span class="title">IDrawBO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Stroke DEFAULT_STROKE = <span class="keyword">new</span> BasicStroke(<span class="number">2</span>,</span><br><span class="line">            BasicStroke.CAP_BUTT, BasicStroke.JOIN_ROUND,</span><br><span class="line">            <span class="number">3.5f</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="keyword">float</span>[]&#123;<span class="number">12</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>&#125;,</span><br><span class="line">            <span class="number">0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Color color;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x2;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是虚线</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> dashed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="d-矩形：-RoundRectBO"><a href="#d-矩形：-RoundRectBO" class="headerlink" title="d. 矩形： RoundRectBO"></a>d. 矩形： RoundRectBO</h4><p>和直线的属性差不多, 但是会多一些有意思的东西，如是否为圆角矩形</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoundRectBO</span> <span class="keyword">implements</span> <span class="title">IDrawBO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Stroke DEFAULT_DASH = <span class="keyword">new</span> BasicStroke(<span class="number">1</span>,</span><br><span class="line">            BasicStroke.CAP_BUTT, BasicStroke.JOIN_ROUND,</span><br><span class="line">            <span class="number">3.5f</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="keyword">float</span>[]&#123;<span class="number">4</span>, <span class="number">2</span>,&#125;,</span><br><span class="line">            <span class="number">0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> w;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> h;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Color color;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否为虚线</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> dashed;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 圆角弧度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> radius;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="e-纯色：-ColorBgBO"><a href="#e-纯色：-ColorBgBO" class="headerlink" title="e. 纯色： ColorBgBO"></a>e. 纯色： ColorBgBO</h4><p>纯色背景，相比较其他的会多一个透明度的属性，主要是因为很多场景下，会做一层纯色的浮层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorBgBO</span> <span class="keyword">implements</span> <span class="title">IDrawBO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Color color;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> w;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> h;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> radius;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> transparence;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>上面定义了这些BO对象，仅仅是定义又什么用？接下来就需要实现对BO对象的绘制，也是核心的逻辑层了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by yihui on 2017/9/21.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IShareModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">draw</span><span class="params">(Graphics2D g2d)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">drawFont</span><span class="params">(Graphics2D g2d, FontBO fontBo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (fontBo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            g2d.setFont(fontBo.getFont());</span><br><span class="line">            g2d.setColor(fontBo.getColor());</span><br><span class="line">            g2d.drawString(fontBo.getMsgs(), fontBo.getX(), fontBo.getY());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fontBo.isDeleted()) &#123; <span class="comment">// 删除时，需要在文字上绘制一条删除线</span></span><br><span class="line">                FontMetrics fontMetrics = FontUtil.getFontMetric(fontBo.getFont());</span><br><span class="line">                <span class="keyword">int</span> y = fontBo.getY() - (fontBo.getFont().getSize() &gt;&gt; <span class="number">1</span>) + fontMetrics.getDescent();</span><br><span class="line">                <span class="keyword">int</span> w = fontMetrics.stringWidth(fontBo.getMsgs());</span><br><span class="line"></span><br><span class="line">                g2d.drawLine(fontBo.getX(), y, fontBo.getX() + w, y);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">drawImage</span><span class="params">(Graphics2D g2d, ImgBO imgBo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (imgBo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            g2d.drawImage(imgBo.getImage(), imgBo.getX(), imgBo.getY(), imgBo.getW(), imgBo.getH(), <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">drawLine</span><span class="params">(Graphics2D g2d, LineBO lineBO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(lineBo == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        g2d.setColor(lineBO.getColor());</span><br><span class="line">        <span class="keyword">if</span> (lineBO.isDashed()) &#123;</span><br><span class="line">            Stroke stroke = g2d.getStroke();</span><br><span class="line">            g2d.setStroke(LineBO.DEFAULT_STROKE);</span><br><span class="line">            g2d.drawLine(lineBO.getX(), lineBO.getY(), lineBO.getX() + lineBO.getW(), lineBO.getY());</span><br><span class="line">            g2d.setStroke(stroke);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            g2d.drawLine(lineBO.getX(), lineBO.getY(), lineBO.getX() + lineBO.getW(), lineBO.getY());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">drawRoundRect</span><span class="params">(Graphics2D g2d, RoundRectBO roundRectBO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(roundRectBO == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        g2d.setColor(roundRectBO.getColor());</span><br><span class="line">        <span class="keyword">if</span> (!roundRectBO.isDashed()) &#123;</span><br><span class="line">            g2d.drawRoundRect(roundRectBO.getX(), roundRectBO.getY(),</span><br><span class="line">                    roundRectBO.getW(),</span><br><span class="line">                    roundRectBO.getH(),</span><br><span class="line">                    roundRectBO.getRadius(),</span><br><span class="line">                    roundRectBO.getRadius());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Stroke stroke = g2d.getStroke();</span><br><span class="line"></span><br><span class="line">            g2d.setStroke(RoundRectBO.DEFAULT_DASH);</span><br><span class="line">            g2d.drawRoundRect(roundRectBO.getX(), roundRectBO.getY(),</span><br><span class="line">                    roundRectBO.getW(),</span><br><span class="line">                    roundRectBO.getH(),</span><br><span class="line">                    roundRectBO.getRadius(),</span><br><span class="line">                    roundRectBO.getRadius());</span><br><span class="line">            g2d.setStroke(stroke);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (roundRectBO.getSpaceW() &gt; <span class="number">0</span>) &#123; <span class="comment">// 上边距空白的宽度</span></span><br><span class="line">            <span class="keyword">int</span> x = roundRectBO.getX() + (roundRectBO.getW() - roundRectBO.getSpaceW() &gt;&gt; <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">int</span> y = roundRectBO.getY() - <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">int</span> w = roundRectBO.getSpaceW();</span><br><span class="line">            <span class="keyword">int</span> h = <span class="number">4</span>;</span><br><span class="line">            g2d.setColor(roundRectBO.getSpaceColor());</span><br><span class="line">            g2d.fillRect(x, y, w, h);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">drawColorBG</span><span class="params">(Graphics2D g2d, ColorBgBO color)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(color == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        g2d.setColor(color.getColor());</span><br><span class="line"></span><br><span class="line">        Composite composite = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (color.isTransparence()) &#123;</span><br><span class="line">            composite = g2d.getComposite();</span><br><span class="line">            g2d.setComposite(AlphaComposite.Src);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (color.getRadius() == <span class="number">0</span>) &#123;</span><br><span class="line">            g2d.fillRect(color.getX(), color.getY(), color.getW(), color.getH());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            g2d.fill(<span class="keyword">new</span> RoundRectangle2D.Float(color.getX(), color.getY(), color.getW(), color.getH(), color.getRadius(), color.getRadius()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (color.isTransparence()) &#123;</span><br><span class="line">            g2d.setComposite(composite);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面配合起来使用，就可以实现基本的模板图片的合成需求了，当然我们提供的服务比上面列出的要丰富一些，我们还支持</p>
<ul>
<li>图片的处理：圆角，裁剪贴图</li>
<li>文字对齐：三种对齐方式，自动换行</li>
</ul>
<hr>
<h4 id="小结-amp-问题"><a href="#小结-amp-问题" class="headerlink" title="小结&amp;问题"></a>小结&amp;问题</h4><p>上面虽然说可以支持合图的需求，但有个最大的问题，就是对后端的工作太多，每个模板，都需要后端来配合，进行参数指定，联调，极其繁琐和费时费力，分分钟搞死人</p>
<p>对这种方式，想的一个方法是，采用搭积木的方式支持，事先定义一系列的基本绘图组建，然后前端自己填入参数来组装</p>
<p>当然没有做，原因也很简单，接口太复杂，对前端不友好，没人愿意这么用，换成我也是不想这么干的</p>
<hr>
<h3 id="3-html-转-图片"><a href="#3-html-转-图片" class="headerlink" title="3. html 转 图片"></a>3. html 转 图片</h3><p>接着又来的是一个猥琐的方案，html转图，到github上一搜，发现还是js靠谱，比较多，一种常见的思路是：</p>
<p><strong>采用无界面浏览器加载html页面，然后截图</strong></p>
<p>在无界面浏览器中，非常有名的是 phantomjs，以及后起之秀chrome，这里主要说一下phantomjs的接入方式，简单提起chrmoe的无界面使用方式</p>
<h4 id="a-环境准备-1"><a href="#a-环境准备-1" class="headerlink" title="a. 环境准备"></a>a. 环境准备</h4><p>phantomjs 安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 1. 下载</span><br><span class="line"></span><br><span class="line">## mac 系统</span><br><span class="line">wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-macosx.zip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## linux 系统</span><br><span class="line">wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2</span><br><span class="line"></span><br><span class="line">## windows 系统</span><br><span class="line">## 就不要玩了，没啥意思</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 2. 解压</span><br><span class="line"></span><br><span class="line">sudo su </span><br><span class="line">tar -jxvf phantomjs-2.1.1-linux-x86_64.tar.bz2</span><br><span class="line"></span><br><span class="line"># 如果解压报错，则安装下面的</span><br><span class="line"># yum -y install bzip2</span><br><span class="line"></span><br><span class="line"># 3. 安装</span><br><span class="line"></span><br><span class="line">## 简单点，移动到bin目录下</span><br><span class="line"></span><br><span class="line">cp phantomjs-2.1.1-linux-x86_64/bin/phantomjs /usr/local/bin</span><br><span class="line"></span><br><span class="line"># 4. 验证是否ok</span><br><span class="line">phantomjs --version</span><br><span class="line"></span><br><span class="line"># 输出版本号，则表示ok</span><br></pre></td></tr></table></figure>
<p>pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--phantomjs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.seleniumhq.selenium<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>selenium-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.53.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.detro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ghostdriver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>jitpack.io<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://jitpack.io<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="b-实测"><a href="#b-实测" class="headerlink" title="b. 实测"></a>b. 实测</h4><p>思路比较清晰，在服务器上搭建一个phantomjs服务，然后java来调用，主要借助的是selenium和ghostdriver两个开源包，额外提一句，selenium在自动化测试和爬虫使用中非常有名，有兴趣的可以自己搜索相关资料，非常有意思的一个东西</p>
<p><strong>图片渲染的主要业务逻辑：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public class Html2ImageByJsWrapper &#123;</span><br><span class="line"></span><br><span class="line">    private static PhantomJSDriver webDriver = getPhantomJs();</span><br><span class="line"></span><br><span class="line">    private static PhantomJSDriver getPhantomJs() &#123;</span><br><span class="line">        //设置必要参数</span><br><span class="line">        DesiredCapabilities dcaps = new DesiredCapabilities();</span><br><span class="line">        //ssl证书支持</span><br><span class="line">        dcaps.setCapability(&quot;acceptSslCerts&quot;, true);</span><br><span class="line">        //截屏支持</span><br><span class="line">        dcaps.setCapability(&quot;takesScreenshot&quot;, true);</span><br><span class="line">        //css搜索支持</span><br><span class="line">        dcaps.setCapability(&quot;cssSelectorsEnabled&quot;, true);</span><br><span class="line">        //js支持</span><br><span class="line">        dcaps.setJavascriptEnabled(true);</span><br><span class="line">        //驱动支持（第二参数表明的是你的phantomjs引擎所在的路径，which/whereis phantomjs可以查看）</span><br><span class="line">        // fixme 这里写了执行， 可以考虑判断系统是否有安装，并获取对应的路径 or 开放出来指定路径</span><br><span class="line">        dcaps.setCapability(PhantomJSDriverService.PHANTOMJS_EXECUTABLE_PATH_PROPERTY, &quot;/usr/local/bin/phantomjs&quot;);</span><br><span class="line">        //创建无界面浏览器对象</span><br><span class="line">        return new PhantomJSDriver(dcaps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static BufferedImage renderHtml2Image(String url) throws IOException &#123;</span><br><span class="line">        webDriver.get(url);</span><br><span class="line">        File file = webDriver.getScreenshotAs(OutputType.FILE);</span><br><span class="line">        return ImageIO.read(file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么测试case就很好写了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testRender() throws IOException &#123;</span><br><span class="line">    String url = &quot;https://www.baidu.com&quot;;</span><br><span class="line">    BufferedImage img = Html2ImageByJsWrapper.renderHtml2Image(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出图片</p>
<p><img src="http://s2.mogucdn.com/mlcdn/c45406/171217_1g98bj21aldjl0655h0adh8dh216a_810x600.jpg" alt="IMAGE"></p>
<p>看到这个结果之后，是否会觉得已经完美了？</p>
<p>然而并不是，测试一些需要异步请求的接口，比较渣，性能差，返回的样式会错乱</p>
<h4 id="c-分析小结"><a href="#c-分析小结" class="headerlink" title="c. 分析小结"></a>c. 分析小结</h4><p>这个方案从实现来讲，是没有什么问题的，从支持情况来说，问题其实也不太大，那为什么不用这个方案呢？</p>
<p>这个方案的支持，原本我的希望是前端传给我们需要渲染的html</p>
<ul>
<li>是直出好的页面</li>
<li>所有的dom结构已经很清晰了，</li>
<li>尽量不要有什么js，</li>
<li>不要有异步请求，</li>
<li>不要又复杂的css依赖，</li>
<li>没有大量的图片</li>
</ul>
<p>然而事与愿违，至于为什么不实现这样的html，我也不太懂前端的技术难点在哪，不好多评，那么也就只好转方案了 </p>
<p>还有一点，对这个方案我不太满意的就是性能太渣，而且我也不知道可以怎么去优化，简单来讲，就是这个js渲染，完全不在我的把控之内，有什么问题、如何去优化、如何防止ssrf攻击，我都没有好的解决办法，所以我本人也是不喜欢这个方案的</p>
<h4 id="d-chrome-方式"><a href="#d-chrome-方式" class="headerlink" title="d. chrome 方式"></a>d. chrome 方式</h4><p>chrome浏览器，大家都知道，chrome还有一种无界面启动方式，可能知道的比较少了</p>
<p>只要你本机安装了chrome浏览器，打开控制台就可以愉快的玩耍了，html输出图片的指令为</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 输出pdf</span></span><br><span class="line">/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --headless --<span class="built_in">print</span>-to-pdf http://www.baidu.com</span><br><span class="line"></span><br><span class="line"><span class="comment">## 输出图片</span></span><br><span class="line">/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --headless --screenshot  http://www.baidu.com</span><br></pre></td></tr></table></figure>
<p>输出截图</p>
<p><img src="http://s2.mogucdn.com/mlcdn/c45406/171217_3j6jcb9h24k4afkhih2gj5771l926_1600x1200.png" alt="screenshot.png"></p>
<p><strong>说明</strong></p>
<p>chrome headless有很多指令，可设置窗口的大小解决上面的边框问题，有兴趣的可以百度</p>
<hr>
<h3 id="4-svg-转-图片"><a href="#4-svg-转-图片" class="headerlink" title="4. svg 转 图片"></a>4. svg 转 图片</h3><p>然后万能的前端同学又提出了svg渲染图片，在提这个之前，完全没接触过svg，也不知道svg是个什么鬼，更不知道svg能不能渲染出图片（最重要的是java有没有现成可用的库）</p>
<p>查了一番，不错，发现apace有个batik，就是干这个事情的</p>
<pre><code>插播一句，感觉无论多偏的东西，apache或者是google都至少有那么一个可以支持的开源项目，虽然有不少都已经不怎么维护了
</code></pre><h4 id="a-依赖整理"><a href="#a-依赖整理" class="headerlink" title="a. 依赖整理"></a>a. 依赖整理</h4><p>依赖包有那么点多</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--batik svg to image--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-svggen<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-bridge<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xalan<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xalan<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-dom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xalan<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xalan<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-parser<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-svg-dom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-transcoder<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-util<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.xmlgraphics/xmlgraphics-commons --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xmlgraphics-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.xmlgraphics/batik-codec --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 此处不能使用2.9.1版本，使用2.9.1生成png会失败 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;dependency&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;groupId&gt;xerces&lt;/groupId&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;artifactId&gt;xercesImpl&lt;/artifactId&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;version&gt;2.5.0&lt;/version&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;/dependency&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xml-apis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xmlParserAPIs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.axsl.org.w3c.dom.svg<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>svg-dom-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xml-apis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xml-apis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.w3c.css<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sac<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="b-实测-1"><a href="#b-实测-1" class="headerlink" title="b. 实测"></a>b. 实测</h4><p>一个简单的接口支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">convertToPngByFile</span><span class="params">(String path, OutputStream outputStream, Map&lt;String, String&gt; parmMap)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> TranscoderException, IOException </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	  <span class="comment">// 1. 加载document</span></span><br><span class="line">		File file = <span class="keyword">new</span> File(path);</span><br><span class="line">		String parser = XMLResourceDescriptor.getXMLParserClassName();</span><br><span class="line">		SAXSVGDocumentFactory f = <span class="keyword">new</span> SAXSVGDocumentFactory(parser);</span><br><span class="line">		Document doc = f.createDocument(file.toURI().toString());</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 2. 遍历参数，填充渲染的svg节点</span></span><br><span class="line">		Set&lt;String&gt; keySet = parmMap.keySet();</span><br><span class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : parmMap.entrySet()) &#123;</span><br><span class="line">			doc.getElementById(entry.getKey()).setTextContent(entry.getValue());</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 3. 输出图片</span></span><br><span class="line">		PNGTranscoder t = <span class="keyword">new</span> PNGTranscoder();</span><br><span class="line">		TranscoderInput input = <span class="keyword">new</span> TranscoderInput(doc);</span><br><span class="line">		TranscoderOutput output = <span class="keyword">new</span> TranscoderOutput(outputStream);</span><br><span class="line">		t.transcode(input, output);</span><br><span class="line">		outputStream.flush();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (outputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				outputStream.close();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面主要是为了演示下使用姿势，实际的项目中肯定不会这么简陋，官方使用链接: <a href="https://xmlgraphics.apache.org/batik/using/transcoder.html" target="_blank" rel="noopener">https://xmlgraphics.apache.org/batik/using/transcoder.html</a></p>
<p>分析下主要流程</p>
<ul>
<li>解析svg文件，加载Document对象</li>
<li>根据传入的参数，填充Document中的节点</li>
<li>渲染输出图片</li>
</ul>
<p>测试演示就不来了，最终方案就是这个，成品也没啥好说的</p>
<h4 id="c-问题"><a href="#c-问题" class="headerlink" title="c. 问题"></a>c. 问题</h4><ol>
<li><p>文本的边框支持问题: 即 outline属性</p>
<p> 测试了好久，发现不支持这个属性</p>
</li>
<li><p>图片内容替换与文本内容替换是不一样的，需要区分对待</p>
</li>
<li><p>多个标签填充同样的内容时</p>
<p> 从接口上来看，支持一个根据Name来获取节点功能，但是实际测试，发现标签name属性，并没有什么鸟用；不知道是使用姿势问题还是别的</p>
<p> 然后翻看源码，发现当多个标签的id相同时，在Document的底层存储单元中，elementById 这个Map结构中，value会是一个数组</p>
<p> 然后自然而然的想法就是，直接遍历这个数组，依次填充内容就好；结果发现压根就没有暴露这个接口，而这个属性是protectd，也无法直接访问</p>
<p> 然后采用反射获取这个属性值，来绕过限制</p>
</li>
<li><p>模板加载缓存</p>
<p> 实际场景中，模板往往是固定的，每次都进行渲染是非常消耗性能的，因此想的是能不能缓存住这个Document，再使用的时候，直接深拷贝一个对象出来，这样就避免了重复加载的开销</p>
<p> 直接使用 <code>AbstractDocumen#deepClone(true)</code> 方法</p>
</li>
</ol>
<p>然后，出现了一个鬼畜的并发问题，这个单独领出来细说，此处不展开</p>
<hr>
<h2 id="III-最后收尾"><a href="#III-最后收尾" class="headerlink" title="III. 最后收尾"></a>III. 最后收尾</h2><p>鉴于篇幅太长，有一些有意思的东西没有深入展开，特别是svg方案的支持中，遇到了一些比较有趣的问题，也涉及到三个好玩的知识点： 深拷贝+反射+并发，后面准备等这一块完结之后，好好的沉淀下，分析下这个case</p>
<h3 id="1-吐槽"><a href="#1-吐槽" class="headerlink" title="1. 吐槽"></a>1. 吐槽</h3><p>后端支持已经很勉强了，请大家都友好点，比如下面几个我实在支持不了</p>
<ul>
<li>自定义设置字体（jdk字体，没新加一个都需要pe安装到jre的字体库）</li>
<li>图片的左上角圆角（暂时没想到好的解决方法）</li>
<li>渐变色（这个有点难）</li>
</ul>
<p>这个需求，做得比较恶心，支持得也比较蛋疼，实现得比较猥琐，调bug修问题也比较闹心，总得来说，是一个开始前很有趣，做时让人吐血又很不爽，做完之后又特么的很有收获的需求</p>
<p>发现特别能有收获的事情，往往不是哪种做的特别爽的需求（爽，是因为这些东西你都完全能hold住，没什么难度了），相反是那些让你很闹心，完全不想继续下去的需求（因为你不了解，但是又不得不支持，还会遇到一堆鬼畜的bug，做完简直是吐血三升）</p>
<h3 id="2-小结"><a href="#2-小结" class="headerlink" title="2. 小结"></a>2. 小结</h3><p>图片合成的方式，我想应该不仅限于上面几种，由于限制于见识，终究是没有一个让人特别满意的方案，简单小结下上面的几种case</p>
<ul>
<li>java的开源包<ul>
<li>html2image, xhtmlrender, pdfTech</li>
<li>一般来说，不怎么好用，大多不维护状态，对CSS的支持友好度待检验</li>
</ul>
</li>
<li>imagemagic<ul>
<li>适用于图片的基本处理，合图太复杂</li>
</ul>
</li>
<li>awt绘图<ul>
<li>属于基本的接口了，啥都可以干，只要你可以弄出来</li>
<li>但是工作量太大</li>
</ul>
</li>
<li>js实现html渲染<ul>
<li>phantmjs，效果不错，性能略渣，异步请求不友好，且完全不可控</li>
<li>chrome 性能由于上面的</li>
</ul>
</li>
<li>svg渲染<ul>
<li>batik</li>
<li>并不能非常完美的支持svg的渲染，有较多的限制要求，各种属性的必填，某些style的无法支持等</li>
<li>基本场景的支持，ok，优化后，性能高于html渲染，且可控</li>
</ul>
</li>
</ul>
<h2 id="III-其他"><a href="#III-其他" class="headerlink" title="III. 其他"></a>III. 其他</h2><h3 id="体验网址"><a href="#体验网址" class="headerlink" title="体验网址"></a>体验网址</h3><p>基于react写了个前端，可以来体验渲染</p>
<ul>
<li><a href="http://liuyueyi.gitee.io/zweb/#/tool/html2img" target="_blank" rel="noopener">phantomJs渲染</a></li>
<li><a href="http://liuyueyi.gitee.io/zweb/#/tool/svg" target="_blank" rel="noopener">svg渲染</a></li>
</ul>
<h3 id="个人博客：-一灰灰Blog"><a href="#个人博客：-一灰灰Blog" class="headerlink" title="个人博客： 一灰灰Blog"></a>个人博客： <a href="https://liuyueyi.github.io/hexblog" target="_blank" rel="noopener">一灰灰Blog</a></h3><p>基于hexo + github pages搭建的个人博客，记录所有学习和工作中的博文，欢迎大家前去逛逛</p>
<h3 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h3><p>尽信书则不如，已上内容，纯属一家之言，因本人能力一般，见识有限，如发现bug或者有更好的建议，随时欢迎批评指正</p>
<ul>
<li>微博地址: <a href="https://weibo.com/p/1005052169825577/home" target="_blank" rel="noopener">小灰灰Blog</a></li>
<li>QQ： 一灰灰/3302797840</li>
</ul>
<h3 id="扫描关注"><a href="#扫描关注" class="headerlink" title="扫描关注"></a>扫描关注</h3><p><img src="https://raw.githubusercontent.com/liuyueyi/Source/master/img/info/blogInfoV2.png" alt="QrCode"></p>
</div><div class="tags"><a href="/hexblog/tags/杂记/">杂记</a></div><div style="text-align:center"><br><button style="color:red;background-color: #f44336;border: none;border-radius: 8px;color: white;padding: 10px 30px;text-align: center;text-decoration: none;font-size: 16px;" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">打赏</button><br><span style="display: block;color: #9d9d9d;font: 14px/2 &amp;quot;Microsoft Yahei&amp;quot;">如果觉得我的文章对您有帮助，请随意打赏。</span><br><div id="QR" style="display: none; margin-top: 20px;" class="row"><div id="wechat" style="display: inline-block;width:44%;margin-left:6%;text-align:center;"><a href="javascript:void(0)"><img src="https://s3.mogucdn.com/mlcdn/c45406/180104_50136i33id9e49j1f7k2e219e3ldf_800x798.png" alt="WeChat Pay" style="width:80%;height:80%;max-height:200px;max-width:200px"></a><p style="text-align:center">微信打赏</p></div><div id="alipay" style="display: inline-block;width:44%;text-align:center"><a href="javascript:void(0)"><img src="https://s3.mogucdn.com/mlcdn/c45406/180104_0e6afl33b23lacj6ji2d7d060aiak_798x800.png" alt="Alipay" style="width:80%;height:80%;max-height:200px;max-width:200px"></a><p style="text-align:center">支付宝打赏</p></div></div></div><div class="article-footer-copyright"><url><li>版权声明：本文由<b> 一灰灰 </b><span>发表于</span><a href="/hexblog/"> 一灰灰Blog </a></li><li>转载声明：自由转载-非商用-非衍生-保持署名，非商业转载请注明作者及出处，商业转载请联系作者本人。</li><li id="blogTitleCp">文章标题：<a style="word-wrap:break-word">图片合成支持的前世今生</a></li><li>文章链接：<a id="blogLink" style="word-wrap:break-word"></a><script>var blogLink = decodeURI(window.location.href);
var doc = document.getElementById('blogLink');
doc.setAttribute("href", blogLink);
doc.innerHTML=blogLink;</script></li></url></div><div class="post-share"><div><script src="https://s3.mogucdn.com/mlcdn/c45406/1520387600580_dom-to-image.min.js" charset="utf-8"></script><script>var url;
console.log('start--->',(new Date()).valueOf());
domtoimage.toPng(document.getElementsByClassName('layout-l')[0])
    .then(function (dataUrl) {
        url = dataUrl;
        console.log('end--->',(new Date()).valueOf());
     })
    .catch(function (error) {});
function link() {
    var title = document.getElementById('blogTitleCp').children[0].innerText;
    console.log("blog title: ", title);
    window.open().document.write('<html><head><title>'+ title + '</title></head><body><div style=\'text-align:center\' ><a download="一灰灰Blog博文_' + title + '.png" href="'+url+'"><img title="点击下载博文图：' + title + '" src="' + url + '" /></a></div></body></html>');
}</script><span style="float:center;font-size:20px;font-weight:solid;color:gray">渲染：</span><a id="saveImg" href="javascript:void(0)" onclick="link()" class="save_img">保存图片</a></div><div id="share" class="soshm social-share"><span style="float:center;font-size:20px;font-weight:solid;color:gray">分享：</span></div></div><div class="post-nav"><a href="/hexblog/2017/12/17/Java学习之深拷贝浅拷贝及对象拷贝的两种方式/" class="pre">Java学习之深拷贝浅拷贝及对象拷贝的两种方式</a><a href="/hexblog/2017/09/08/ForkJoin-学习使用笔记/" class="next">ForkJoin 学习使用笔记</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNDY0OC8xMTE4NQ=="></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei"> 文章目录</i><a title="点击展开或隐藏分类" href="javascript:void(0)" onclick="showOrHide('toc', 'toc-expand', 'none')"><span id="toc-expand" style="font-size:12px;color:red"> 点击收起 </span></a></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#图片合成的前世今生"><span class="toc-text">图片合成的前世今生</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I-背景"><span class="toc-text">I. 背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-无聊的技术研究"><span class="toc-text">0. 无聊的技术研究</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-蛋疼的小程序"><span class="toc-text">1. 蛋疼的小程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-开动"><span class="toc-text">2. 开动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#II-技术尝试"><span class="toc-text">II. 技术尝试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-java的html渲染库"><span class="toc-text">0. java的html渲染库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-html2image"><span class="toc-text">a. html2image</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-xhtml渲染包"><span class="toc-text">b. xhtml渲染包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c-借助转pdf的包"><span class="toc-text">c. 借助转pdf的包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#d-小结"><span class="toc-text">d. 小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-imagemagic的合成"><span class="toc-text">1. imagemagic的合成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-环境准备"><span class="toc-text">a. 环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-java调用"><span class="toc-text">b. java调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c-其他一些不得不说的故事"><span class="toc-text">c. 其他一些不得不说的故事</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-awt的绘制"><span class="toc-text">2. awt的绘制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#o-接口定义"><span class="toc-text">o. 接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#a-图片-：-ImgBO"><span class="toc-text">a. 图片 ： ImgBO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-文字：FontBO"><span class="toc-text">b. 文字：FontBO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c-直线-LineBO"><span class="toc-text">c. 直线: LineBO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#d-矩形：-RoundRectBO"><span class="toc-text">d. 矩形： RoundRectBO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#e-纯色：-ColorBgBO"><span class="toc-text">e. 纯色： ColorBgBO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结-amp-问题"><span class="toc-text">小结&amp;问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-html-转-图片"><span class="toc-text">3. html 转 图片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-环境准备-1"><span class="toc-text">a. 环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-实测"><span class="toc-text">b. 实测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c-分析小结"><span class="toc-text">c. 分析小结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#d-chrome-方式"><span class="toc-text">d. chrome 方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-svg-转-图片"><span class="toc-text">4. svg 转 图片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-依赖整理"><span class="toc-text">a. 依赖整理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-实测-1"><span class="toc-text">b. 实测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c-问题"><span class="toc-text">c. 问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#III-最后收尾"><span class="toc-text">III. 最后收尾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-吐槽"><span class="toc-text">1. 吐槽</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-小结"><span class="toc-text">2. 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#III-其他"><span class="toc-text">III. 其他</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#体验网址"><span class="toc-text">体验网址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#个人博客：-一灰灰Blog"><span class="toc-text">个人博客： 一灰灰Blog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#声明"><span class="toc-text">声明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扫描关注"><span class="toc-text">扫描关注</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><a href="/hexblog/about/"><i class="fa fa-user"> 一灰灰Blog</i></a><a title="点击展开或收起条目" href="javascript:void(0)" onclick="showOrHide('info-list', 'info-list-expand', 'none')"><span id="info-list-expand" style="font-size:12px;color:red"> 点击收起 </span></a></div><ul class="post-list info-list"><li style="text-align:center"><img src="//s3.mogucdn.com/mlcdn/c45406/170419_637cgff527i8k9k8h512iaf36cdia_600x600.jpg" style="max-width:80px;radius:80px"/><p style="text-align:center">好好学习，天天搬砖</p><hr style="height:0.1px;border:none;border-top:1px dashed #0066CC;"/></li><li class="post-list-item"><a href="mailto:bangzewu@126.com" title="126邮箱" class="post-list-link"><i class="fa fa-email">  bangzewu@126.com</i></a></li><li class="post-list-item"><a href="//github.com/liuyueyi" title="Git主页" target="_blank" class="post-list-link"><i class="fa fa-github">  github.com/liuyueyi</i></a></li><li class="post-list-item"><a href="" title="QQ" class="post-list-link"><i class="fa fa-you">  QQ:3302797840</i></a></li><li class="post-list-item"><a href="//weibo.com/p/1005052169825577/home" title="微博主页" target="_blank" class="post-list-link"><i class="fa fa-weibo">  微博:小灰灰Blog</i></a></li><li class="post-list-item"><i class="fa fa-weixin">  微信公众号</i></li><li style="text-align:center" class="post-list-item"><img src="https://s10.mogucdn.com/mlcdn/c45406/171229_1cgld3igbelkbc70cd8af1j3809kb_150x150.jpg"/></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章(10)</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/04/16/CSS图片点击拷贝/">CSS图片点击拷贝</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/04/13/生产环境分库分表的实际操作全记录/">生产环境分库分表的实际操作全记录</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/04/11/Mybatis框架学习之使用篇二：标签语法/">Mybatis框架学习之使用篇二：标签语法</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/04/11/Mybatis框架学习之使用篇一：基本环境/">Mybatis框架学习之使用篇一：基本环境</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/04/10/Java实现邮件发送/">Java实现邮件发送</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/04/09/基于ForkJoin构建一个简单易用的并发组件/">基于ForkJoin构建一个简单易用的并发组件</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/04/01/Css实战训练之图片点击放大/">Css实战训练之图片点击放大</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/04/01/Css学习手册之基本篇/">Css学习手册之基本篇</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/23/mysql之锁与事务详解/">mysql之锁与事务详解</a></li><li class="post-list-item"><a class="post-list-link" href="/hexblog/2018/03/22/mysql之索引的工作机制/">mysql之索引的工作机制</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类(60)</i><a title="点击展开或隐藏分类" href="javascript:void(0)" onclick="showOrHide('category-list-child', 'category-expand', 'block')"><span id="category-expand" style="font-size:12px;color:red"> 点击展开 </span></a></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/工作/">工作</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/工作/分库分表/">分库分表</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/工作/技术尝鲜/">技术尝鲜</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/">技术</a><span class="category-list-count">50</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Android/">Android</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Android/一封/">一封</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/BugFix/">BugFix</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/BugFix/Java/">Java</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/BugFix/Java/Image/">Image</a><span class="category-list-count">2</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/DB/">DB</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/DB/Mybatis/">Mybatis</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/DB/Mysql/">Mysql</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/">Java</a><span class="category-list-count">19</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/IO/">IO</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/JDK/">JDK</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/JVM/">JVM</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/JavaWeb/">JavaWeb</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/Spring/">Spring</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Java/并发/">并发</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Quick系列项目/">Quick系列项目</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Quick系列项目/QuickAlarm/">QuickAlarm</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Quick系列项目/QuickSpi/">QuickSpi</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Redis/">Redis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Shell/">Shell</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Shell/Git/">Git</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Shell/Git/Maven/">Maven</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Shell/Nginx/">Nginx</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/Shell/环境搭建/">环境搭建</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/前端/">前端</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/前端/Chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/前端/Css/">Css</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/技术/前端/Jquery/">Jquery</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/杂记/">杂记</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/杂记/idea/">idea</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/杂记/吐槽/">吐槽</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/杂记/小工具/">小工具</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/生活/">生活</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/hexblog/categories/生活/随笔/">随笔</a><span class="category-list-count">1</span></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签墙(60)</i><a title="点击展开或隐藏分类" href="javascript:void(0)" onclick="showOrHide('tagcloud', 'tag-expand', 'none')"><span id="tag-expand" style="font-size:12px;color:red"> 点击收起 </span></a></div><div class="tagcloud"><!--!= tagcloud({min_font: 15, max_font: 15, amount: 100, orderby: 'count'})--><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/File/">File</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/JVM/">JVM</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/日记/">日记</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Android/">Android</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/一封/">一封</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/RelativeLayout/">RelativeLayout</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/CountDownTimer/">CountDownTimer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Bugfix/">Bugfix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Java/">Java</a><span class="tag-list-count">34</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/batik/">batik</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Png/">Png</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Gitbook/">Gitbook</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Centos/">Centos</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/教程/">教程</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Chrome/">Chrome</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/工具/">工具</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/css/">css</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/笔记/">笔记</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/并发/">并发</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/ForkJoin/">ForkJoin</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Reflect/">Reflect</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Jquery/">Jquery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/ClassLoader/">ClassLoader</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/双亲委托/">双亲委托</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/内存结构/">内存结构</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/垃圾回收/">垃圾回收</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/JavaWeb/">JavaWeb</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Filter/">Filter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Servlet/">Servlet</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/JDK/">JDK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Initialize/">Initialize</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/ScheduledExecutorService/">ScheduledExecutorService</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/IO/">IO</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/clone/">clone</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/beancopy/">beancopy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Email/">Email</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/ThreadPoolExecutor/">ThreadPoolExecutor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/mybatis/">mybatis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/配置/">配置</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Redis/">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/distributeLock/">distributeLock</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/SPI/">SPI</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/整体设计/">整体设计</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/使用手册/">使用手册</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Spring/">Spring</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/RequestParam/">RequestParam</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Jsonp/">Jsonp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/CORS/">CORS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Exception/">Exception</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Response/">Response</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/ffmpeg/">ffmpeg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/imagemagic/">imagemagic</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/mysql/">mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/索引/">索引</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/锁/">锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/事务/">事务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Github/">Github</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Maven/">Maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/BugFix/">BugFix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/BufferedImage/">BufferedImage</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Jpeg/">Jpeg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/杂记/">杂记</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/Okhttp/">Okhttp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/QuickAlarm/">QuickAlarm</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/hystrix/">hystrix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/分库分表/">分库分表</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/随笔/">随笔</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/hexblog/tags/拷贝/">拷贝</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档(60)</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2018/04/">四月 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2018/03/">三月 2018</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2018/02/">二月 2018</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2018/01/">一月 2018</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2017/12/">十二月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2017/08/">八月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexblog/archives/2017/05/">五月 2017</a><span class="archive-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 更多链接</i></div><ul style="padding-top:10px"></ul><li style="padding-top:2px"><a href="//my.oschina.net/u/566591" title="开源中国" target="_blank">开源中国</a></li><li style="padding-top:2px"><a href="//blog.csdn.net/liuyueyi25" title="CSDN" target="_blank">CSDN</a></li><li style="padding-top:2px"><a href="//www.jianshu.com/u/5902ab08e670" title="简书" target="_blank">简书</a></li><li style="padding-top:2px"><a href="//juejin.im/user/5a2a4b095188252ae93adbbf/posts" title="掘金" target="_blank">掘金</a></li><li style="padding-top:2px"><a href="//www.toutiao.com/c/user/69862071663/#mid=1579653107239950" title="头条" target="_blank">头条</a></li><li style="padding-top:2px"><a href="//cloud.tencent.com/developer/column/1847" title="云+" target="_blank">云+</a></li><li style="padding-top:2px"><a href="//github.com/liuyueyi" title="Github" target="_blank">Github</a></li><li style="padding-top:2px"><a href="//gitee.com/liuyueyi" title="Gitee" target="_blank">Gitee</a></li></div><div class="widget"><div class="widget-title"><i onclick="var qr = document.getElementById('qrcode'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}" style="cursor:pointer" class="fa fa-hit"> 点赞(点击展开)</i></div><ul id="qrcode" style="display:none;" class="post-list"><br/><li style="text-align:center" class="post-list-item"><a href="javascript:void(0)" target="_blank"><img src="https://s3.mogucdn.com/mlcdn/c45406/180104_50136i33id9e49j1f7k2e219e3ldf_800x798.png" alt="WeChat Pay" style="width:75%"/><br/><p style="text-align:center">微信打赏</p></a></li><li style="text-align:center" class="post-list-item"><a href="javascript:void(0)" target="_blank"><img src="https://s3.mogucdn.com/mlcdn/c45406/180104_0e6afl33b23lacj6ji2d7d060aiak_798x800.png" alt="Alipay" style="width:75%"/><br/><p style="text-align:center">支付宝打赏</p></a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="render"><script src="https://s3.mogucdn.com/mlcdn/c45406/1520387600580_dom-to-image.min.js" charset="utf-8"></script><div class="rInput"><input id="choose-id" type="text" placeholder="cid: | id: + 标签" onkeydown="if(event.keyCode==13) {doRender();}"></div><div class="rSendBtn"><a id="rImgBtn" onclick="doRender()">渲染</a></div></div><script type="text/javascript" src="/hexblog/js/render.js?v=2.0.1" async></script><div id="footer"><div class="footer-info"><p><a href="https://zbang.online/webs"><img src="//s3.mogucdn.com/mlcdn/c45406/170419_637cgff527i8k9k8h512iaf36cdia_600x600.jpg" style="max-width: 44px;border-radius:44px"></a></p><p><a href="https://github.com/liuyueyi" target="_blank">GitHub</a> |  <a href="mailto:bangzewu@126.com">email</a> |  <a href="/hexblog/about/">关于 |</a><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p></p><p><span> Copyright &copy;<a href="/hexblog/." rel="nofollow">YiHui.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?028d9e53f991d9739ecc7cc42e13c500";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/hexblog/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/hexblog/js/toctotop.js?v=2.0.1" async></script><script src="https://s3.mogucdn.com/mlcdn/c45406/1520407228303_social-share.min.js" charset="utf-8"></script><link rel="stylesheet" href="https://s3.mogucdn.com/mlcdn/c45406/1518422561591_share.min.css"><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body><script type="text/javascript" src="/hexblog/js/common.js?v=2.0.1" async></script></html>
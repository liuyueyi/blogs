<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Batik渲染png图片异常的bug修复"/>




  <meta name="keywords" content="Bugfix,Java,batik,Png," />





  <link rel="alternate" href="/hexblog/atom.xml" title="Z+ | Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/hexblog/favicon.ico?v=1.1" />



<link rel="canonical" href="https://zbang.online/hexblog/2018/01/20/Batik渲染png图片异常的bug修复/"/>


<meta name="description" content="Batik渲染png图片异常的bug修复batik是apache的一个开源项目，可以实现svg的渲染，后端借助它可以比较简单的实现图片渲染，当然和java一贯处理图片不太方便一样，使用起来也有不少坑 下面记录一个bug的修复过程">
<meta name="keywords" content="Bugfix,Java,batik,Png">
<meta property="og:type" content="article">
<meta property="og:title" content="Batik渲染png图片异常的bug修复">
<meta property="og:url" content="https://zbang.online/hexblog/2018/01/20/Batik渲染png图片异常的bug修复/index.html">
<meta property="og:site_name" content="Z+ | Blog">
<meta property="og:description" content="Batik渲染png图片异常的bug修复batik是apache的一个开源项目，可以实现svg的渲染，后端借助它可以比较简单的实现图片渲染，当然和java一贯处理图片不太方便一样，使用起来也有不少坑 下面记录一个bug的修复过程">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://s17.mogucdn.com/mlcdn/c45406/180119_67ik6b6l9kb199gjaachbkdce89dk_1274x284.jpg">
<meta property="og:image" content="https://s17.mogucdn.com/mlcdn/c45406/180119_61el9dg4f32iafif6i57g0hac8e7i_1328x832.jpg">
<meta property="og:image" content="https://s17.mogucdn.com/mlcdn/c45406/180119_645jcjh7hae6g6e7k3bakhje593a7_1320x508.jpg">
<meta property="og:image" content="https://s10.mogucdn.com/mlcdn/c45406/180103_61hi8f7kldkl202fked3k2g0ial1e_640x340.jpg">
<meta property="og:updated_time" content="2018-01-19T12:49:06.608Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Batik渲染png图片异常的bug修复">
<meta name="twitter:description" content="Batik渲染png图片异常的bug修复batik是apache的一个开源项目，可以实现svg的渲染，后端借助它可以比较简单的实现图片渲染，当然和java一贯处理图片不太方便一样，使用起来也有不少坑 下面记录一个bug的修复过程">
<meta name="twitter:image" content="https://s17.mogucdn.com/mlcdn/c45406/180119_67ik6b6l9kb199gjaachbkdce89dk_1274x284.jpg">


<link rel="stylesheet" type="text/css" href="/hexblog/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Batik渲染png图片异常的bug修复 - Z+ | Blog </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/hexblog/." class="logo">Z+ | Blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/hexblog/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/hexblog/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">



    <header class="post-header">
      <h1 class="post-title">
        
          Batik渲染png图片异常的bug修复
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          <i class="fa fa-calendar"></i>
          2018-01-20
          
              | <i class="fa fa-folder"></i>
              
                - <a href="/hexblog/categories/Java/">Java</a>
              
                - <a href="/hexblog/categories/Java/BugFix/">BugFix</a>
              
          
        </span>

      </div>
    </header>



    
            <div class="post-content">
            <h1 id="Batik渲染png图片异常的bug修复"><a href="#Batik渲染png图片异常的bug修复" class="headerlink" title="Batik渲染png图片异常的bug修复"></a>Batik渲染png图片异常的bug修复</h1><p>batik是apache的一个开源项目，可以实现svg的渲染，后端借助它可以比较简单的实现图片渲染，当然和java一贯处理图片不太方便一样，使用起来也有不少坑</p>
<p>下面记录一个bug的修复过程</p>
<a id="more"></a>
<h2 id="I-问题重现"><a href="#I-问题重现" class="headerlink" title="I. 问题重现"></a>I. 问题重现</h2><p>svg文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">"200"</span> <span class="attr">height</span>=<span class="string">"200"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">x</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xlink:href</span>=<span class="string">"http://image.uc.cn/o/wemedia/s/upload/2017/39c53604fe3587a4876396cf3785b801x200x200x13.png"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--xlink:href="https://s17.mogucdn.com/mlcdn/c45406/180119_46ld8kkb54d3el06hela5d61e18f5_1024x966.png"/&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--xlink:href="http://avatar.csdn.net/A/8/B/3_u010889145.jpg"/&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>依次测试了三个图片，两个png，一个jpg，很不幸第一个png会抛异常</p>
<p>输出的堆栈信息如</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">The URI <span class="string">"http://image.uc.cn/o/wemedia/s/upload/2017/39c53604fe3587a4876396cf3785b801x200x200x13.png"</span></span><br><span class="line">on element &lt;image&gt; can<span class="string">'t be opened because:</span></span><br><span class="line"><span class="string">PNG URL is corrupt or unsupported variant</span></span><br><span class="line"><span class="string">	at org.apache.batik.bridge.UserAgentAdapter.getBrokenLinkDocument(UserAgentAdapter.java:448)</span></span><br><span class="line"><span class="string">	at org.apache.batik.bridge.SVGImageElementBridge.createRasterImageNode(SVGImageElementBridge.java:642)</span></span><br><span class="line"><span class="string">	at org.apache.batik.bridge.SVGImageElementBridge.createImageGraphicsNode(SVGImageElementBridge.java:340)</span></span><br><span class="line"><span class="string">	at org.apache.batik.bridge.SVGImageElementBridge.buildImageGraphicsNode(SVGImageElementBridge.java:180)</span></span><br><span class="line"><span class="string">	at org.apache.batik.bridge.SVGImageElementBridge.createGraphicsNode(SVGImageElementBridge.java:122)</span></span><br><span class="line"><span class="string">	at org.apache.batik.bridge.GVTBuilder.buildGraphicsNode(GVTBuilder.java:213)</span></span><br><span class="line"><span class="string">	at org.apache.batik.bridge.GVTBuilder.buildComposite(GVTBuilder.java:171)</span></span><br><span class="line"><span class="string">	at org.apache.batik.bridge.GVTBuilder.build(GVTBuilder.java:82)</span></span><br><span class="line"><span class="string">	at org.apache.batik.transcoder.SVGAbstractTranscoder.transcode(SVGAbstractTranscoder.java:208)</span></span><br><span class="line"><span class="string">	at org.apache.batik.transcoder.image.ImageTranscoder.transcode(ImageTranscoder.java:92)</span></span><br><span class="line"><span class="string">	at org.apache.batik.transcoder.XMLAbstractTranscoder.transcode(XMLAbstractTranscoder.java:142)</span></span><br><span class="line"><span class="string">	at org.apache.batik.transcoder.SVGAbstractTranscoder.transcode(SVGAbstractTranscoder.java:156)</span></span><br><span class="line"><span class="string">	...</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="II-问题定位及分析"><a href="#II-问题定位及分析" class="headerlink" title="II. 问题定位及分析"></a>II. 问题定位及分析</h2><p>既然出现了这个问题，那么就要去修复解决了，当然遇到这么鬼畜的问题，最常见的几个步骤：</p>
<ol>
<li>其他人遇到过么 （问百度） – 结果度娘没有给出任何有效的建议，也没有搜到任何有用的信息</li>
<li>然后问谷歌，靠谱了一点，至少有些相关的主题了，但建设性的意见也没收到</li>
<li>外援实在找不到，只能debug查问题了</li>
</ol>
<h3 id="1-DEBUG的一路"><a href="#1-DEBUG的一路" class="headerlink" title="1. DEBUG的一路"></a>1. DEBUG的一路</h3><p>通过上面的堆栈信息，可以想见，debug的几个地方也和明确了，首先定位到下面这一行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.batik.bridge.UserAgentAdapter.getBrokenLinkDocument(UserAgentAdapter.java:448)</span><br></pre></td></tr></table></figure>
<p>为什么这么干？因为首先得确认下这个异常是怎么抛出来的，逆向推，直接看源码，发现直接抛出异常</p>
<p><img src="https://s17.mogucdn.com/mlcdn/c45406/180119_67ik6b6l9kb199gjaachbkdce89dk_1274x284.jpg" alt="2A02AB38-25ED-4B71-8CE7-76460623FE08.png"></p>
<p>再往上走</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.batik.bridge.SVGImageElementBridge.createRasterImageNode(SVGImageElementBridge.java:642)</span><br></pre></td></tr></table></figure>
<p><img src="https://s17.mogucdn.com/mlcdn/c45406/180119_61el9dg4f32iafif6i57g0hac8e7i_1328x832.jpg" alt="D1CECFCF-D940-4A17-87F9-7E12B00517D9.png"></p>
<p>所以说因为这个if条件判断成立，导致进入了这个异常逻辑，判断的逻辑也没啥好说的，现在的关键是这个参数对象img是怎么来的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.batik.bridge.SVGImageElementBridge.createImageGraphicsNode(SVGImageElementBridge.java:340)</span><br></pre></td></tr></table></figure>
<p><img src="https://s17.mogucdn.com/mlcdn/c45406/180119_645jcjh7hae6g6e7k3bakhje593a7_1320x508.jpg" alt="IMAGE"></p>
<p>然后就稍微清晰一点了，直接将火力放在下面的方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">org.apache.batik.ext.awt.image.spi.ImageTagRegistry#readURL(java.io.InputStream, </span><br><span class="line">    org.apache.batik.util.ParsedURL, </span><br><span class="line">    org.apache.xmlgraphics.java2d.color.ICCColorSpaceWithIntent, </span><br><span class="line">    <span class="keyword">boolean</span>, </span><br><span class="line">    <span class="keyword">boolean</span>)</span><br></pre></td></tr></table></figure>
<p>在这个方法内部，也没什么好说的，单步多调几次，就能发现异常的case是怎么来的了，省略掉中间各种单步debug的过程，下面直接进入关键链路</p>
<h3 id="2-火力全开，问题定位"><a href="#2-火力全开，问题定位" class="headerlink" title="2. 火力全开，问题定位"></a>2. 火力全开，问题定位</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.batik.ext.awt.image.codec.imageio.AbstractImageIORegistryEntry</span><br></pre></td></tr></table></figure>
<p>通过上面的一路之后，发现最终的关键就是上面这个抽象类，顺带也可以看下这个抽象类的几个子类，有JPEGxxx, PNGxxx, TIFFxxx，然后问题来了，都已经有相关实现了，所以png讲道理应该是会支持的才对吧，但和实际的表现太不一样了吧，所以有必要撸一把源码了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Filter <span class="title">handleStream</span><span class="params">(InputStream inIS,</span></span></span><br><span class="line"><span class="function"><span class="params">                           ParsedURL   origURL,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">boolean</span>     needRawData)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> DeferRable  dr  = <span class="keyword">new</span> DeferRable();</span><br><span class="line">    <span class="keyword">final</span> InputStream is  = inIS;</span><br><span class="line">    <span class="keyword">final</span> String      errCode;</span><br><span class="line">    <span class="keyword">final</span> Object []   errParam;</span><br><span class="line">    <span class="keyword">if</span> (origURL != <span class="keyword">null</span>) &#123;</span><br><span class="line">        errCode  = ERR_URL_FORMAT_UNREADABLE;</span><br><span class="line">        errParam = <span class="keyword">new</span> Object[] &#123;getFormatName(), origURL&#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        errCode  = ERR_STREAM_FORMAT_UNREADABLE;</span><br><span class="line">        errParam = <span class="keyword">new</span> Object[] &#123;getFormatName()&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Thread t = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Filter filt;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                Iterator&lt;ImageReader&gt; iter = ImageIO.getImageReadersByMIMEType(</span><br><span class="line">                        getMimeTypes().get(<span class="number">0</span>).toString());</span><br><span class="line">                <span class="keyword">if</span> (!iter.hasNext()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(</span><br><span class="line">                            <span class="string">"No image reader for "</span></span><br><span class="line">                                + getFormatName() + <span class="string">" available!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ImageReader reader = iter.next();</span><br><span class="line">                ImageInputStream imageIn = ImageIO.createImageInputStream(is);</span><br><span class="line">                reader.setInput(imageIn, <span class="keyword">true</span>);</span><br><span class="line">      </span><br><span class="line">                <span class="keyword">int</span> imageIndex = <span class="number">0</span>;</span><br><span class="line">                dr.setBounds(<span class="keyword">new</span> Rectangle2D.Double</span><br><span class="line">                             (<span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                              reader.getWidth(imageIndex),</span><br><span class="line">                              reader.getHeight(imageIndex)));</span><br><span class="line">                CachableRed cr;</span><br><span class="line">                <span class="comment">//Naive approach possibly wasting lots of memory</span></span><br><span class="line">                <span class="comment">//and ignoring the gamma correction done by PNGRed :-(</span></span><br><span class="line">                <span class="comment">//Matches the code used by the former JPEGRegistryEntry, though.</span></span><br><span class="line">                BufferedImage bi = reader.read(imageIndex);</span><br><span class="line">                cr = GraphicsUtil.wrap(bi);</span><br><span class="line">                cr = <span class="keyword">new</span> Any2sRGBRed(cr);</span><br><span class="line">                cr = <span class="keyword">new</span> FormatRed(cr, GraphicsUtil.sRGB_Unpre);</span><br><span class="line">                WritableRaster wr = (WritableRaster)cr.getData();</span><br><span class="line">                ColorModel cm = cr.getColorModel();</span><br><span class="line">                BufferedImage image = <span class="keyword">new</span> BufferedImage</span><br><span class="line">                    (cm, wr, cm.isAlphaPremultiplied(), <span class="keyword">null</span>);</span><br><span class="line">                cr = GraphicsUtil.wrap(image);</span><br><span class="line">                filt = <span class="keyword">new</span> RedRable(cr);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                    <span class="comment">// Something bad happened here...</span></span><br><span class="line">                    filt = ImageTagRegistry.getBrokenLinkImage</span><br><span class="line">                        (AbstractImageIORegistryEntry.<span class="keyword">this</span>,</span><br><span class="line">                         errCode, errParam);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ThreadDeath td) &#123;</span><br><span class="line">                filt = ImageTagRegistry.getBrokenLinkImage</span><br><span class="line">                    (AbstractImageIORegistryEntry.<span class="keyword">this</span>,</span><br><span class="line">                     errCode, errParam);</span><br><span class="line">                dr.setSource(filt);</span><br><span class="line">                <span class="keyword">throw</span> td;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                filt = ImageTagRegistry.getBrokenLinkImage</span><br><span class="line">                    (AbstractImageIORegistryEntry.<span class="keyword">this</span>,</span><br><span class="line">                     errCode, errParam);</span><br><span class="line">            &#125;</span><br><span class="line">  </span><br><span class="line">            dr.setSource(filt);</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  t.start();</span><br><span class="line">  <span class="keyword">return</span> dr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看上面的实现是一个非常有意思的事情， 开了一个线程做事情，而且直接就返回了，相当于给了别人一个储物箱的钥匙，虽然现在储物箱是空的，但是回头我会填满的</p>
<p>言归正传，主要的业务逻辑就在这个线程里了，核心的几行代码就是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载图片，转为BufferedImage对象</span></span><br><span class="line">BufferedImage bi = reader.read(imageIndex);</span><br><span class="line">cr = GraphicsUtil.wrap(bi);</span><br><span class="line"><span class="comment">// 下面实现对图片的ARGB进行修改</span></span><br><span class="line">cr = <span class="keyword">new</span> Any2sRGBRed(cr);</span><br><span class="line">cr = <span class="keyword">new</span> FormatRed(cr, GraphicsUtil.sRGB_Unpre);</span><br><span class="line">WritableRaster wr = (WritableRaster)cr.getData();</span><br><span class="line">ColorModel cm = cr.getColorModel();</span><br><span class="line">BufferedImage image = <span class="keyword">new</span> BufferedImage</span><br><span class="line">    (cm, wr, cm.isAlphaPremultiplied(), <span class="keyword">null</span>);</span><br><span class="line">cr = GraphicsUtil.wrap(image);</span><br><span class="line">filt = <span class="keyword">new</span> RedRable(cr);</span><br></pre></td></tr></table></figure>
<p>debug上面的几行代码，发现问题比较明显了，就是这个图片的转换跪了，至于为啥？ java的图片各种蛋疼至极，这里面的逻辑，真心搞不进去，so深挖到此为止</p>
<hr>
<h2 id="III-兼容逻辑"><a href="#III-兼容逻辑" class="headerlink" title="III. 兼容逻辑"></a>III. 兼容逻辑</h2><p>问题定位到了，当然就是想办法来修复了，简单来说，需要兼容的就是图片的类型转换上了，直接用原来的可能会抛异常，所以做了一个简单的兼容逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(bi.getType() == BufferedImage.TYPE_BYTE_INDEXED) &#123;</span><br><span class="line">    BufferedImage image = <span class="keyword">new</span> BufferedImage(bi.getWidth(), bi.getHeight(), BufferedImage.TYPE_INT_ARGB);</span><br><span class="line">    Graphics2D g2d = image.createGraphics();</span><br><span class="line">    g2d.drawImage(bi, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">    g2d.dispose();</span><br><span class="line">    cr = GraphicsUtil.wrap(image);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cr = GraphicsUtil.wrap(bi);</span><br><span class="line">    cr = <span class="keyword">new</span> Any2sRGBRed(cr);</span><br><span class="line">    cr = <span class="keyword">new</span> FormatRed(cr, GraphicsUtil.sRGB_Unpre);</span><br><span class="line">    WritableRaster wr = (WritableRaster)cr.getData();</span><br><span class="line">    ColorModel cm = cr.getColorModel();</span><br><span class="line">    BufferedImage image = <span class="keyword">new</span> BufferedImage</span><br><span class="line">        (cm, wr, cm.isAlphaPremultiplied(), <span class="keyword">null</span>);</span><br><span class="line">    cr = GraphicsUtil.wrap(image);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次验证，ok</p>
<p><strong>注意：</strong></p>
<p>一个问题来了，上面的兼容是需要修改源码的，我们可以怎么办？有几种解决方法</p>
<ul>
<li>猥琐方法一：down下源码，修改版本，然后传到自己的私服，使用自己的vip包</li>
<li>猥琐方法二：把 batik-codec 工程原样拷贝到自己的项目中，就可以随意的使用改了</li>
<li>猥琐方法三：写一个完全相同的类（包路径完全相同），然后构造一个自定义类加载器，加载这个自己的这个兼容版本的，替换原来的（未测试，不确定是否能行）</li>
</ul>
<p>至于我的选择，就是使用了猥琐方法二</p>
<h2 id="IV-其他"><a href="#IV-其他" class="headerlink" title="IV. 其他"></a>IV. 其他</h2><h3 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h3><p>尽信书则不如，已上内容，纯属一家之言，因本人能力一般，见解不全，如有问题，欢迎批评指正</p>
<h3 id="扫描关注，java分享"><a href="#扫描关注，java分享" class="headerlink" title="扫描关注，java分享"></a>扫描关注，java分享</h3><p><img src="https://s10.mogucdn.com/mlcdn/c45406/180103_61hi8f7kldkl202fked3k2g0ial1e_640x340.jpg" alt="QrCode"></p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
      <i class="fa fa-tags"></i>
			<a href="/hexblog/tags/Bugfix/">Bugfix</a>
		  
      <i class="fa fa-tags"></i>
			<a href="/hexblog/tags/Java/">Java</a>
		  
      <i class="fa fa-tags"></i>
			<a href="/hexblog/tags/batik/">batik</a>
		  
      <i class="fa fa-tags"></i>
			<a href="/hexblog/tags/Png/">Png</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/hexblog/2018/01/22/兼容ImageIO读取jpeg图片变红/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">兼容ImageIO读取jpeg图片变红</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/hexblog/2018/01/19/SpringMVC支持跨域的几种姿势/">
        <span class="next-text nav-default">SpringMVC支持跨域的几种姿势</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2017 -
    
    2018
    <span class="footer-author">YiHui.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/hexblog/lib/jquery/jquery-3.1.1.min.js"></script>
  

  


<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script type="text/javascript" src="/hexblog/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/hexblog/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>

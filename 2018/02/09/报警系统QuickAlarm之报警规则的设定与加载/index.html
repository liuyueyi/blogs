<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="报警系统QuickAlarm之报警规则的设定与加载"/>




  <meta name="keywords" content="Java,SPI,QuickAlarm," />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?028d9e53f991d9739ecc7cc42e13c500";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>





  <link rel="alternate" href="/hexblog/atom.xml" title="Z+ | Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/hexblog/favicon.ico?v=1.1" />



<link rel="canonical" href="https://zbang.online/hexblog/2018/02/09/报警系统QuickAlarm之报警规则的设定与加载/"/>


<meta name="description" content="前面一篇是报警执行器的定义与加载已经完成，但与之对应的报警规则有是如何定义和加载的呢？ 此外，既然命名为规则，那么就需要有对应的解析器，以根据报警规则和报警类型等相关输入条件，来选择对应的报警执行器，因此本文主要包括的内容就比较清晰了  报警规则的定义 报警规则的加载 报警规则的解析以及报警执行器选择">
<meta name="keywords" content="Java,SPI,QuickAlarm">
<meta property="og:type" content="article">
<meta property="og:title" content="报警系统QuickAlarm之报警规则的设定与加载">
<meta property="og:url" content="https://zbang.online/hexblog/2018/02/09/报警系统QuickAlarm之报警规则的设定与加载/index.html">
<meta property="og:site_name" content="Z+ | Blog">
<meta property="og:description" content="前面一篇是报警执行器的定义与加载已经完成，但与之对应的报警规则有是如何定义和加载的呢？ 此外，既然命名为规则，那么就需要有对应的解析器，以根据报警规则和报警类型等相关输入条件，来选择对应的报警执行器，因此本文主要包括的内容就比较清晰了  报警规则的定义 报警规则的加载 报警规则的解析以及报警执行器选择">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://s17.mogucdn.com/mlcdn/c45406/180209_74fic633aebgh5dgfhid2fiiggc99_1220x480.png">
<meta property="og:updated_time" content="2018-02-09T14:12:43.871Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="报警系统QuickAlarm之报警规则的设定与加载">
<meta name="twitter:description" content="前面一篇是报警执行器的定义与加载已经完成，但与之对应的报警规则有是如何定义和加载的呢？ 此外，既然命名为规则，那么就需要有对应的解析器，以根据报警规则和报警类型等相关输入条件，来选择对应的报警执行器，因此本文主要包括的内容就比较清晰了  报警规则的定义 报警规则的加载 报警规则的解析以及报警执行器选择">
<meta name="twitter:image" content="https://s17.mogucdn.com/mlcdn/c45406/180209_74fic633aebgh5dgfhid2fiiggc99_1220x480.png">


<link rel="stylesheet" type="text/css" href="/hexblog/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> 报警系统QuickAlarm之报警规则的设定与加载 - Z+ | Blog </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/hexblog/." class="logo">Z+ | Blog</a>
        <span style="margin-left:20px;color:#E02222;font-size:18px">一灰灰个人博客</span>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/hexblog/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/hexblog/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">



    <header class="post-header">
      <h1 class="post-title">
        
          报警系统QuickAlarm之报警规则的设定与加载
        
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          <i class="fa fa-calendar"></i>
          2018-02-09
          
              | <i class="fa fa-folder"></i>
              
                - <a href="/hexblog/categories/Java/">Java</a>
              
                - <a href="/hexblog/categories/Java/QuickAlarm/">QuickAlarm</a>
              
          
        </span>

      </div>
    </header>



    
            <div class="post-content">
            <p>前面一篇是报警执行器的定义与加载已经完成，但与之对应的报警规则有是如何定义和加载的呢？</p>
<p>此外，既然命名为规则，那么就需要有对应的解析器，以根据报警规则和报警类型等相关输入条件，来选择对应的报警执行器，因此本文主要包括的内容就比较清晰了</p>
<ul>
<li>报警规则的定义</li>
<li>报警规则的加载</li>
<li>报警规则的解析以及报警执行器选择</li>
</ul>
<a id="more"></a>
<h2 id="I-报警规则定义"><a href="#I-报警规则定义" class="headerlink" title="I. 报警规则定义"></a>I. 报警规则定义</h2><blockquote>
<p>目前针对报警规则没有给出自定义配置的入口，即完全采用了默认的方案，后续可以考虑支持适用方来自定义报警规则以及解析器，这样扩展性就更强了</p>
</blockquote>
<p>首先说明下我们的设计规则，我们针对不同的AlarmExecute定义了一个优先级，我们的目标是</p>
<ul>
<li>针对报警频率设置不同区间，每个区间对应一种报警类型</li>
<li>当实际调用的报警频率达到这个区间，就选择这种报警类型</li>
<li>同时也允许关闭根据频率选择报警器的功能，全程用一个默认</li>
<li>每种报警类型的用户都可以自定义</li>
</ul>
<p>针对上面的目标，我们设计的类就比较明确了</p>
<p>阀值类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlarmThreshold</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">AlarmThreshold</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 报警类型，对应 &#123;<span class="doctag">@link</span> IExecute#getName()&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String alarmLevel;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 晋升此报警的阀值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> threshold;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对应的报警用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; users;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(AlarmThreshold o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> threshold - o.getThreshold();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlarmConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MIN_NUM = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_NUM = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 报警用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; users;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 报警的阀值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;AlarmThreshold&gt; alarmThreshold;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最小的报警数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> minLimit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最大的报警数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxLimit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 报警类型 &#123;<span class="doctag">@link</span> IExecute#getName()&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String alarmLevel;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * true 表示当报警超过当前的阀值之后, 将提升报警的程度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> autoIncEmergency;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个报警类型对应一个<code>AlarmConfig</code>，这样当执行报警时，就可以很容易的获取对应的规则</p>
<p>同样根据定义，也可以看出报警规则比较简单，直接根据阀值区间来选择</p>
<h2 id="II-报警规则加载"><a href="#II-报警规则加载" class="headerlink" title="II. 报警规则加载"></a>II. 报警规则加载</h2><p>关于如何加载报警规则，想了很久，选择把这块放开，因为我们无法确定，使用方的配置是存在什么地方的，而且使用的配置是否能和我们的设计的DO兼容也是个问题，因此干脆放手，同样是通过SPI的方式来做的</p>
<p>我们定义规则加载接口： IConfLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IConfLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载配置到内存的操作，启动时，被调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 表示加载成功; false 表示加载失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序，越小优先级越高</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 说明： 当系统中多个Loader存在时，会根据优先级来选择order最小的一个作为默认的Loader</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取注册信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">RegisterInfo <span class="title">getRegisterInfo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否开启报警</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">alarmEnable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据报警类型，获取对应的报警规则</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> alarmKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">AlarmConfig <span class="title">getAlarmConfig</span><span class="params">(String alarmKey)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的方法，可以划分为两类: </p>
<ul>
<li>加载时使用<ul>
<li>load 为具体的执行加载配置到内存的方法，返回true表示加载成功</li>
<li>order 排序</li>
<li>getRegisterInfo 获取基础的配置信息（包括应用名等相关配置）</li>
</ul>
</li>
<li>业务运行时使用<ul>
<li>alarmEnable ： 是否开启报警 （当大量报警时，可以先关闭报警，然后再查问题）</li>
<li>getAlarmConfig：核心方法，根据报警类型，返回对应的报警规则</li>
</ul>
</li>
</ul>
<p>系统默认提供一个从配置文件中加载报警规则的方案，主要会依赖两个配置文件</p>
<ul>
<li>alarm.properties : 初始化注册信息，内部保存 RegisterInfo 所需要的属性</li>
<li>alarmConfig : 保存具体的报警规则，json格式</li>
</ul>
<h3 id="1-配置加载"><a href="#1-配置加载" class="headerlink" title="1. 配置加载"></a>1. 配置加载</h3><p>配置加载的实现逻辑，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesConfLoader</span> <span class="keyword">implements</span> <span class="title">IConfLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RegisterInfo registerInfo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, AlarmConfig&gt; cacheMap;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取注册信息</span></span><br><span class="line">        registerInfo = RegisterInfoLoaderHelper.load();</span><br><span class="line">        <span class="keyword">if</span> (registerInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取报警的配置类</span></span><br><span class="line">        File file;</span><br><span class="line">        String path = registerInfo.getAlarmConfPath();</span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">            file = <span class="keyword">new</span> File(path);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            URL url = <span class="keyword">this</span>.getClass().getClassLoader().getResource(path);</span><br><span class="line">            file = <span class="keyword">new</span> File(url.getFile());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载成功，才替换 cacheMap的内容； 主要是为了防止修改配置出现问题</span></span><br><span class="line">        Map&lt;String, AlarmConfig&gt; tmp = init(file);</span><br><span class="line">        <span class="keyword">boolean</span> ans = tmp != <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 注册配置文件的变动</span></span><br><span class="line">        ans = ans &amp;&amp; PropertiesConfListenerHelper.registerConfChangeListener(file, <span class="keyword">this</span>::init);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ans) &#123;</span><br><span class="line">            cacheMap = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, AlarmConfig&gt; <span class="title">init</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 正常来讲，是一个完整的json串</span></span><br><span class="line">            List&lt;String&gt; list = IOUtils.readLines(<span class="keyword">new</span> FileInputStream(file), <span class="string">"utf-8"</span>);</span><br><span class="line">            String config = Joiner.on(<span class="string">""</span>).join(list);</span><br><span class="line">            <span class="keyword">return</span> AlarmConfParse.parseConfig(config, Splitter.on(<span class="string">","</span>).splitToList(registerInfo.getDefaultAlarmUsers()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">"load config into cacheMap error! e: &#123;&#125;"</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RegisterInfo <span class="title">getRegisterInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> registerInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">alarmEnable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AlarmConfig <span class="title">getAlarmConfig</span><span class="params">(String alarmKey)</span> </span>&#123;</span><br><span class="line">        AlarmConfig config = cacheMap.get(alarmKey);</span><br><span class="line">        <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cacheMap.get(AlarmConfParse.DEFAULT_ALARM_KEY);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> config;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要查看默认的load方法即可, alarmEnable 和 getAlarmConfig还是比较简单的，看一下就知道怎么玩的</p>
<h3 id="2-RegisterInfo-加载"><a href="#2-RegisterInfo-加载" class="headerlink" title="2. RegisterInfo 加载"></a>2. RegisterInfo 加载</h3><p>上面的实现中，第一步就是从 alarm.properteis 文件中读取对应的配置，然后初始化 RegisterInfo对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisterInfo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 报警规则文件的路径，系统默认加载时，必填；否则选填</span></span><br><span class="line">    <span class="keyword">private</span> String alarmConfPath;</span><br><span class="line">    <span class="comment">// 最大报警类型数，非必填，默认1000</span></span><br><span class="line">    <span class="keyword">private</span> Integer maxAlarmType;</span><br><span class="line">    <span class="comment">// 默认报警用户， 必须</span></span><br><span class="line">    <span class="keyword">private</span> String defaultAlarmUsers;</span><br><span class="line">    <span class="comment">// 应用名， 必须</span></span><br><span class="line">    <span class="keyword">private</span> String appName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个配置文件实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">appName=test</span><br><span class="line">alarmConfPath=/tmp/alarmConfig</span><br><span class="line">maxAlarmType=1000</span><br><span class="line">defaultAlarmUsers=yihui</span><br></pre></td></tr></table></figure>
<p>从配置文件中读取信息，然后初始化对象的过程就比较简单了，我这里做了一个小简化，使用反射的方式实现对象拷贝</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(Properties source, Object dest)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</span><br><span class="line">    Field[] fields = dest.getClass().getDeclaredFields();</span><br><span class="line">    <span class="keyword">for</span> (Field f : fields) &#123;</span><br><span class="line">        <span class="comment">// 不修改静态变量</span></span><br><span class="line">        <span class="keyword">if</span> (Modifier.isStatic(f.getModifiers())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 值拷贝，因为不同数据类型的问题，所以需要对properties中获取的String类型转换一把</span></span><br><span class="line">        f.set(dest, parseObj(source.getProperty(f.getName()), f.getType()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 强制类型转换</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">parseObj</span><span class="params">(String obj, Class&lt;T&gt; clz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ParseFuncEnum.getFunc(clz).apply(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的实现目前比较简单，没有考虑父类的情况，没有考虑复杂的数据类型转换，目前只支持了基本类型的转换，后续可考虑抽象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ParseFuncEnum &#123;</span><br><span class="line"></span><br><span class="line">    INT_PARSE(Arrays.asList(<span class="keyword">int</span>.class, Integer.class)) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Function&lt;String, Integer&gt; <span class="title">getFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Integer::valueOf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    LONG_PARSE(Arrays.asList(<span class="keyword">long</span>.class, Long.class)) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Function&lt;String, Long&gt; <span class="title">getFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Long::valueOf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    BOOLEAN_PARSE(Arrays.asList(<span class="keyword">boolean</span>.class, Boolean.class)) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Function&lt;String, Boolean&gt; <span class="title">getFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Boolean::valueOf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    FLOAT_PARSE(Arrays.asList(<span class="keyword">float</span>.class, Float.class)) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Function&lt;String, Float&gt; <span class="title">getFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Float::valueOf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    DOUBLE_PARSSE(Arrays.asList(<span class="keyword">double</span>.class, Double.class)) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Function&lt;String, Double&gt; <span class="title">getFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Double::valueOf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    SHORT_PARSE(Arrays.asList(<span class="keyword">short</span>.class, Short.class)) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Function&lt;String, Short&gt; <span class="title">getFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Short::valueOf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    BYTE_PARSE(Arrays.asList(<span class="keyword">byte</span>.class, Byte.class)) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Function&lt;String, Byte&gt; <span class="title">getFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Byte::valueOf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    CHAR_PARSE(Arrays.asList(<span class="keyword">char</span>.class, Character.class)) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Function&lt;String, Character&gt; <span class="title">getFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> s -&gt; s.charAt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    STRING_PARSE(Arrays.asList(String.class)) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Function&lt;String, String&gt; <span class="title">getFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> s -&gt; s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Class&gt; clzList;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">Function&lt;String, T&gt; <span class="title">getFunc</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class, ParseFuncEnum&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (ParseFuncEnum enu : ParseFuncEnum.values()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Class clz : enu.clzList) &#123;</span><br><span class="line">                map.put(clz, enu);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ParseFuncEnum(List&lt;Class&gt; clz) &#123;</span><br><span class="line">        <span class="keyword">this</span>.clzList = clz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Function&lt;String, T&gt; <span class="title">getFunc</span><span class="params">(Class&lt;T&gt; clz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> map.get(clz).getFunc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-报警规则加载"><a href="#3-报警规则加载" class="headerlink" title="3. 报警规则加载"></a>3. 报警规则加载</h4><p>注册信息加载完毕之后，就可以获取报警规则的文件地址了，因此首先是读取配置规则的内容（我们要求是JSON格式），然后反序列化即可</p>
<p>将json串格式配置，反序列化为 BaseAlarmConf 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> TypeReference&lt;Map&lt;String, BasicAlarmConfig&gt;&gt; typeReference </span><br><span class="line">    = <span class="keyword">new</span> TypeReference&lt;Map&lt;String, BasicAlarmConfig&gt;&gt;() &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将json串格式的报警规则配置，映射为对应实体类</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 如果传如的是null, 则采用默认的兜底配置</span></span><br><span class="line"><span class="comment"> * 如果传入的是非法的配置，直接返回null， 这样做的目的如下</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * - 启动时，直接获知配置有问题，需要修改</span></span><br><span class="line"><span class="comment"> * - 启动中，修改配置，此时新配置有问题，依然使用旧的配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> configs</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, BasicAlarmConfig&gt; <span class="title">parseStrConfig2Map</span><span class="params">(String configs)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, BasicAlarmConfig&gt; map = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (configs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            map = JSON.parseObject(configs, typeReference);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"ConfigWrapper.parseStrConfig2Map() init config error! configs: &#123;&#125;, e:&#123;&#125;"</span>, configs, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">        map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!map.containsKey(DEFAULT_ALARM_KEY)) &#123;</span><br><span class="line">        map.put(DEFAULT_ALARM_KEY, DEFAULT_ALARM_CONFIG);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要额外说明一下，json串并没有直接的映射我们前面定义的 <code>AlarmConfig</code> 对象，因为在原型版本的设计的过程中，考虑到配置与内部的使用对象，可能不是特别匹配，最初的设计中，是希望直接将AlarmConfig中的alarmLevel直接替换成 <code>AlarmExecute</code> 实例对象的，然而在实际实现中没有这么干…，所以看源码时，这里就有点奇怪，后面完全可以干掉这个无用的逻辑</p>
<p>此外，就是需要给一个默认的配置项，当报警类型匹配不到对应的报警规则时，就选择默认的了</p>
<p>下面是一个报警配置的demo</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"default"</span>: &#123;</span><br><span class="line">        <span class="attr">"level"</span>: <span class="string">"LOG"</span>,</span><br><span class="line">        <span class="attr">"autoIncEmergency"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"max"</span>: <span class="number">30</span>,</span><br><span class="line">        <span class="attr">"min"</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">"threshold"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"level"</span>: <span class="string">"SMS"</span>,</span><br><span class="line">                <span class="attr">"threshold"</span>: <span class="number">20</span>,</span><br><span class="line">                <span class="attr">"users"</span>: [</span><br><span class="line">                    <span class="string">"345345345345"</span>,</span><br><span class="line">                    <span class="string">"123123123123"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"level"</span>: <span class="string">"WEIXIN"</span>,</span><br><span class="line">                <span class="attr">"threshold"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"users"</span>: [</span><br><span class="line">                    <span class="string">"yihui"</span>,</span><br><span class="line">                    <span class="string">"erhui"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"level"</span>: <span class="string">"LOG"</span>,</span><br><span class="line">                <span class="attr">"threshold"</span>: <span class="number">5</span>,</span><br><span class="line">                <span class="attr">"users"</span>: [</span><br><span class="line">                    <span class="string">"yihui"</span>,</span><br><span class="line">                    <span class="string">"erhui"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"users"</span>: [</span><br><span class="line">            <span class="string">"yihui"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"NPE"</span>: &#123;</span><br><span class="line">        <span class="attr">"level"</span>: <span class="string">"WEIXIN"</span>,</span><br><span class="line">        <span class="attr">"autoIncEmergency"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"max"</span>: <span class="number">30</span>,</span><br><span class="line">        <span class="attr">"min"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"threshold"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"level"</span>: <span class="string">"SMS"</span>,</span><br><span class="line">                <span class="attr">"threshold"</span>: <span class="number">20</span>,</span><br><span class="line">                <span class="attr">"users"</span>: [</span><br><span class="line">                    <span class="string">"345345345345"</span>,</span><br><span class="line">                    <span class="string">"123123123123"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"level"</span>: <span class="string">"WEIXIN"</span>,</span><br><span class="line">                <span class="attr">"threshold"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"users"</span>: [</span><br><span class="line">                    <span class="string">"3h    ui"</span>,</span><br><span class="line">                    <span class="string">"4hui"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"users"</span>: [</span><br><span class="line">            <span class="string">"yihui"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"XXX,YYY"</span>: &#123;</span><br><span class="line">        <span class="attr">"level"</span>: <span class="string">"EMAIL"</span>,</span><br><span class="line">        <span class="attr">"autoIncEmergency"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"max"</span>: <span class="number">30</span>,</span><br><span class="line">        <span class="attr">"min"</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">"threshold"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"level"</span>: <span class="string">"SMS"</span>,</span><br><span class="line">                <span class="attr">"threshold"</span>: <span class="number">20</span>,</span><br><span class="line">                <span class="attr">"users"</span>: [</span><br><span class="line">                    <span class="string">"345345345345"</span>,</span><br><span class="line">                    <span class="string">"123123123123"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"level"</span>: <span class="string">"WEIXIN"</span>,</span><br><span class="line">                <span class="attr">"threshold"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"users"</span>: [</span><br><span class="line">                    <span class="string">"yihui"</span>,</span><br><span class="line">                    <span class="string">"erhui"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"level"</span>: <span class="string">"EMAIL"</span>,</span><br><span class="line">                <span class="attr">"threshold"</span>: <span class="number">5</span>,</span><br><span class="line">                <span class="attr">"users"</span>: [</span><br><span class="line">                    <span class="string">"yihui@xxx.com"</span>,</span><br><span class="line">                    <span class="string">"erhui@xxx.com"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"users"</span>: [</span><br><span class="line">            <span class="string">"yihui@xxx.com"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="III-ConfLoader选择并初始化"><a href="#III-ConfLoader选择并初始化" class="headerlink" title="III. ConfLoader选择并初始化"></a>III. ConfLoader选择并初始化</h2><p>前面说明，为了确保报警规则的多样性存储与加载，我们支持用户自定义加载类，所以就会有这么个ConfLoaderFactory, 来创建系统中使用的ConfLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfLoaderFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IConfLoader currentAlarmConfLoader;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IConfLoader <span class="title">loader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (currentAlarmConfLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ConfLoaderFactory.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (currentAlarmConfLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    initConfLoader();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> currentAlarmConfLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initConfLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator&lt;IConfLoader&gt; iterator = ServiceLoader.load(IConfLoader.class).iterator();</span><br><span class="line"></span><br><span class="line">        List&lt;IConfLoader&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 根据优先级进行排序，选择第一个加载成功的Loader</span></span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            list.add(iterator.next());</span><br><span class="line">        &#125;</span><br><span class="line">        list.sort(Comparator.comparingInt(IConfLoader::order));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (IConfLoader iConfLoader : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (iConfLoader.load()) &#123;</span><br><span class="line">                currentAlarmConfLoader = iConfLoader;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentAlarmConfLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoAlarmLoaderSpecifyException(<span class="string">"no special alarmConfLoader selected!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现逻辑依旧采取了SPI机制，不够我们定义了一个优先级，默认从最高优先级的开始加载，加载成功之后，就选择这个东西了；否则继续加载下一个，当所有的ConfLoader加载完毕，都没有一个成功的，就抛出一个异常</p>
<h2 id="IV-小结"><a href="#IV-小结" class="headerlink" title="IV. 小结"></a>IV. 小结</h2><p>鉴于篇幅问题，关于报警规则与报警执行器之间的关系，对应的解释器放在下一篇进行说明，简要小结一下本文内容</p>
<ul>
<li>报警规则： 采用阀值区间方式，将报警频率与报警执行器关联起来</li>
<li>规则加载： 支持SPI方式注入用户加载器，默认提供基于配置文件的加载器，且优先级最低</li>
</ul>
<h2 id="V-其他"><a href="#V-其他" class="headerlink" title="V. 其他"></a>V. 其他</h2><h3 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h3><ul>
<li>项目地址： <a href="https://github.com/liuyueyi/quick-alarm" target="_blank" rel="noopener">Quick-Alarm</a></li>
<li>博客地址： <a href="https://liuyueyi.github.io/hexblog/" target="_blank" rel="noopener">小灰灰Blog</a></li>
</ul>
<h3 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h3><p>尽信书则不如，已上内容，纯属一家之言，因本人能力一般，见解不全，如有问题，欢迎批评指正</p>
<h3 id="扫描关注，java分享"><a href="#扫描关注，java分享" class="headerlink" title="扫描关注，java分享"></a>扫描关注，java分享</h3><p><img src="https://s17.mogucdn.com/mlcdn/c45406/180209_74fic633aebgh5dgfhid2fiiggc99_1220x480.png" alt="QrCode"></p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
      <i class="fa fa-tags"></i>
			<a href="/hexblog/tags/Java/">Java</a>
		  
      <i class="fa fa-tags"></i>
			<a href="/hexblog/tags/SPI/">SPI</a>
		  
      <i class="fa fa-tags"></i>
			<a href="/hexblog/tags/QuickAlarm/">QuickAlarm</a>
		  
		</div>
		


      
      <div style="text-align:center">
        <button id="rewardButton" style="color:red;background-color: #f44336;border: none;border-radius: 8px;color: white;padding: 10px 30px;text-align: center;text-decoration: none;font-size: 16px;" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}"><span>打赏</span>
        </button>
      </div>
      <div id="QR" class="row" style="display: none; margin-top: 20px;">
        <div id="wechat" style="display: inline-block;width:44%;margin-left:6%;text-align:center;">
          <a href="https://s3.mogucdn.com/mlcdn/c45406/180104_50136i33id9e49j1f7k2e219e3ldf_800x798.png" rel="group">  <img id="wechat_qr" src="https://s3.mogucdn.com/mlcdn/c45406/180104_50136i33id9e49j1f7k2e219e3ldf_800x798.png" alt="WeChat Pay" style="width:80%;height:80%;max-height:200px;max-width:200px">
          </a>
          <p style="text-align:center">微信打赏</p>
        </div>
        <div id="alipay" style="display: inline-block;width:44%;text-align:center">
          <a href="https://s3.mogucdn.com/mlcdn/c45406/180104_0e6afl33b23lacj6ji2d7d060aiak_798x800.png" rel="group" style="width:80%">
            <img id="alipay_qr" src="https://s3.mogucdn.com/mlcdn/c45406/180104_0e6afl33b23lacj6ji2d7d060aiak_798x800.png" alt="Alipay" style="width:80%;height:80%;max-height:200px;max-width:200px">
          </a>
          <p style="text-align:center">支付宝打赏</p>
        </div>
      </div>
      


        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/hexblog/2018/02/09/报警系统QuickAlarm之报警执行器的设计与实现/">
        <span class="next-text nav-default">报警系统QuickAlarm之报警执行器的设计与实现</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2017 -
    
    2018
    <span class="footer-author">YiHui.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/hexblog/lib/jquery/jquery-3.1.1.min.js"></script>
  

  


<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script type="text/javascript" src="/hexblog/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/hexblog/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
